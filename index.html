<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidency Agenda Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #1f2937;
        }
        summary {
            cursor: pointer;
            padding: 1rem;
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }
        .dark summary {
            background-color: #6366f1;
        }
        summary:hover {
            background-color: #4338ca;
        }
        .dark summary:hover {
            background-color: #4f46e5;
        }
        summary::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.3s ease-in-out;
            margin-left: 0.5rem;
        }
        details[open] > summary::after {
            transform: rotate(180deg);
        }
        details > div {
            padding: 1.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .dark details > div {
            background-color: #374151;
            border-color: #4b5563;
        }
        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .dark input[type="text"],
        .dark input[type="date"],
        .dark textarea,
        .dark select {
            background-color: #4b5563;
            border-color: #6b7280;
            color: white;
        }
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        .error-border {
            border-color: #ef4444;
        }
        textarea {
            min-height: 100px;
        }
        label {
            font-weight: 500;
            color: #374151;
        }
        .dark label {
            color: #d1d5db;
        }
        .helper-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
        }
        .error-text {
            color: #ef4444;
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-width: 48px;
            min-height: 48px;
        }
        button:hover {
            transform: scale(1.05);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-edit {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .btn-edit:hover {
            background-color: #4b5563;
        }
        .dynamic-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .dark .dynamic-item {
            background-color: #4b5563;
        }
        .pending-item {
            background-color: #fefcbf;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark .pending-item {
            background-color: #6b7280;
        }
        .review-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }
        .dark .review-item {
            background-color: #4b5563;
        }
        #message-box {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #message-box.error {
            background-color: #ef4444;
        }
        #message-box.show {
            opacity: 1;
        }
        #action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }
        .dark #action-buttons {
            background-color: #1f2937;
        }
        #load-modal, #item-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        #load-modal-content, #item-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .dark #load-modal-content, .dark #item-modal-content {
            background-color: #374151;
        }
        @media (max-width: 640px) {
            #action-buttons {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
            .max-w-2xl {
                max-width: 100%;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            button[title]:hover::after {
                content: attr(title);
                position: absolute;
                background-color: #374151;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                white-space: nowrap;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Presidency Meeting Agenda</h1>
            <button id="theme-toggle" class="btn-secondary" title="Toggle Dark Mode" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="mb-6">
            <button id="view-past-button" class="btn-secondary" aria-label="View past agendas"><i class="fas fa-history mr-1"></i> View Past Agendas</button>
        </div>

        <div class="mb-6 flex items-center">
            <label for="accordion-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Accordion Mode (Mobile):</label>
            <input type="checkbox" id="accordion-toggle" checked class="h-5 w-5">
        </div>

        <form id="agenda-form">
            <details class="mb-4" open>
                <summary>Meeting Details</summary>
                <div class="space-y-4">
                    <div>
                        <label for="meeting-date">Date:</label>
                        <input type="date" id="meeting-date" name="meeting-date" required autocomplete="off">
                        <p class="helper-text error-text hidden" id="meeting-date-error">Required</p>
                    </div>
                    <div>
                        <label for="conducting">Conducting:</label>
                        <input type="text" id="conducting" name="conducting" placeholder="Name of person conducting" autocomplete="name" required>
                        <p class="helper-text error-text hidden" id="conducting-error">Required</p>
                    </div>
                    <div>
                        <label for="opening-prayer">Opening Prayer:</label>
                        <input type="text" id="opening-prayer" name="opening-prayer" placeholder="Name of person praying" autocomplete="name" required>
                        <p class="helper-text error-text hidden" id="opening-prayer-error">Required</p>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Follow-Up</summary>
                <div class="space-y-4">
                    <div>
                        <label for="follow-up-notes">Assignments from previous meeting / ward youth council:</label>
                        <textarea id="follow-up-notes" name="follow-up-notes" placeholder="Discuss status of previous assignments..."></textarea>
                    </div>
                    <div>
                        <label for="previous-ideas">Ideas from Previous Meeting:</label>
                        <textarea id="previous-ideas" name="previous-ideas" placeholder="Ideas carried over from the last meeting..."></textarea>
                    </div>
                    <div id="previous-assignments-display" class="text-sm text-gray-600 dark:text-gray-300">
                        <h4 class="font-semibold mb-2">Pending Assignments from Past Meetings:</h4>
                        <ul id="pending-items-list" class="list-disc pl-5"></ul>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Ministering</summary>
                <div>
                    <label for="ministering-discussion">How can we invite and help our quorum or class come unto Christ? Support them and others?</label>
                    <textarea id="ministering-discussion" name="ministering-discussion" placeholder="Discussion notes..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Assignments:</h4>
                    <ul id="ministering-assignments-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('assignment', -1)" class="btn-secondary text-sm" aria-label="Add a new ministering assignment"><i class="fas fa-plus mr-1"></i> Add Assignment</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Sunday Quorum/Class Meetings</summary>
                <div>
                    <label for="sunday-discussion">What to discuss with quorum/class members? (Ref: "Counsel Together")</label>
                    <textarea id="sunday-discussion" name="sunday-discussion" placeholder="Discussion points for Sunday..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Upcoming Lessons:</h4>
                    <ul id="lessons-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('lesson', -1)" class="btn-secondary text-sm" aria-label="Add a new lesson"><i class="fas fa-plus mr-1"></i> Add Lesson</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Service & Activities</summary>
                <div>
                    <label for="skills-ideas">Skills to learn/develop? How to serve others?</label>
                    <textarea id="skills-ideas" name="skills-ideas" placeholder="Brainstorm ideas..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Planned Service/Activities:</h4>
                    <ul id="activities-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('activity', -1)" class="btn-secondary text-sm" aria-label="Add a new activity"><i class="fas fa-plus mr-1"></i> Add Activity</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Other Discussion Items</summary>
                <div class="space-y-4">
                    <div>
                        <label for="temple-history">Temple & Family History / Sharing the Gospel:</label>
                        <textarea id="temple-history" name="temple-history" placeholder="Notes on participation..."></textarea>
                    </div>
                    <div>
                        <label for="spirit-unity">Inviting the Spirit / Fostering Unity:</label>
                        <textarea id="spirit-unity" name="spirit-unity" placeholder="Ideas and plans..."></textarea>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Leadership Instruction</summary>
                <div>
                    <label for="leadership-instruction">Notes from Bishopric Member or Adult Adviser:</label>
                    <textarea id="leadership-instruction" name="leadership-instruction" placeholder="Record instructions given..."></textarea>
                </div>
            </details>

            <details class="mb-4">
                <summary>Review & Closing</summary>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">Items for Review:</h4>
                        <div id="review-items-list"></div>
                    </div>
                    <div>
                        <label for="closing-prayer">Closing Prayer:</label>
                        <input type="text" id="closing-prayer" name="closing-prayer" placeholder="Name of person praying" autocomplete="name">
                    </div>
                </div>
            </details>

            <div class="mt-8 flex flex-wrap justify-center gap-4" id="desktop-buttons">
                <button type="button" id="save-button" class="btn-primary" aria-label="Save the current agenda"><i class="fas fa-save mr-1"></i> Save Agenda</button>
                <button type="button" id="create-new-button" class="btn-success" aria-label="Create a new agenda"><i class="fas fa-plus mr-1"></i> Create New Agenda</button>
                <button type="button" id="export-pdf-button" class="btn-primary" aria-label="Export agenda as PDF"><i class="fas fa-file-pdf mr-1"></i> Export as PDF</button>
                <button type="button" id="clear-button" class="btn-secondary" aria-label="Clear the form"><i class="fas fa-eraser mr-1"></i> Clear Form</button>
            </div>
        </form>

        <div id="action-buttons" class="hidden sm:hidden">
            <button type="button" id="mobile-save-button" class="btn-primary" title="Save Agenda" aria-label="Save the current agenda"><i class="fas fa-save"></i></button>
            <button type="button" id="mobile-create-new-button" class="btn-success" title="Create New Agenda" aria-label="Create a new agenda"><i class="fas fa-plus"></i></button>
            <button type="button" id="mobile-export-pdf-button" class="btn-primary" title="Export as PDF" aria-label="Export agenda as PDF"><i class="fas fa-file-pdf"></i></button>
            <button type="button" id="mobile-clear-button" class="btn-secondary" title="Clear Form" aria-label="Clear the form"><i class="fas fa-eraser"></i></button>
        </div>
    </div>

    <div id="load-modal">
        <div id="load-modal-content">
            <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Load Past Agenda</h2>
            <div class="flex mb-4">
                <select id="load-agenda" class="flex-grow">
                    <option value="">-- Select an Agenda --</option>
                </select>
                <button id="load-button" class="btn-primary ml-2" aria-label="Load selected agenda">Load</button>
            </div>
            <button id="close-modal-button" class="btn-secondary w-full" aria-label="Close modal">Close</button>
        </div>
    </div>

    <div id="item-modal">
        <div id="item-modal-content">
            <h2 id="item-modal-title" class="text-lg font-semibold mb-4 text-gray-800 dark:text-white"></h2>
            <form id="item-modal-form" class="space-y-4"></form>
            <p id="item-modal-error" class="helper-text error-text hidden">Please fill in all required fields.</p>
            <div class="flex gap-4 mt-4">
                <button type="button" id="item-modal-confirm" class="btn-primary flex-grow" aria-label="Confirm item">Confirm</button>
                <button type="button" id="item-modal-cancel" class="btn-secondary flex-grow" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="message-box"><i id="message-icon" class="fas"></i><span id="message-text"></span></div>

    <script>
        const { jsPDF } = window.jspdf || {};
        const form = document.getElementById('agenda-form');
        const loadAgendaSelect = document.getElementById('load-agenda');
        const messageBox = document.getElementById('message-box');
        const messageIcon = document.getElementById('message-icon');
        const messageText = document.getElementById('message-text');
        let messageTimeout;
        let ministeringAssignmentCount = 0;
        let lessonCount = 0;
        let activityCount = 0;
        let autosaveTimeout;
        let currentModalType = '';
        let currentModalIndex = -1;

        // Theme Handling
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // Show Message
        function showMessage(message, isError = false, duration = 4000) {
            console.log(`${isError ? 'Error' : 'Message'}: ${message}`);
            messageText.textContent = message;
            messageIcon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}`;
            messageBox.classList.remove('error');
            if (isError) messageBox.classList.add('error');
            messageBox.classList.add('show');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Modal Handling
        function openLoadModal() {
            document.getElementById('load-modal').style.display = 'flex';
            populateLoadAgendaDropdown();
        }
        function closeLoadModal() {
            document.getElementById('load-modal').style.display = 'none';
        }

        function openItemModal(type, index) {
            console.log('Opening item modal:', { type, index });
            currentModalType = type;
            currentModalIndex = index;
            const modalTitle = document.getElementById('item-modal-title');
            const modalForm = document.getElementById('item-modal-form');
            const isEdit = index !== -1;
            modalTitle.textContent = isEdit ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            modalForm.innerHTML = '';

            let data = {};
            if (isEdit) {
                const formData = getFormData();
                if (type === 'assignment') data = formData.ministeringAssignments[index] || {};
                else if (type === 'lesson') data = formData.lessons[index] || {};
                else if (type === 'activity') data = formData.activities[index] || {};
            }

            if (type === 'assignment') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-task">Task:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-task" value="${sanitizeInput(data.task || '')}" placeholder="Assignment description" required>
                    </div>
                    <div>
                        <label for="modal-assigned">Assigned To:</label>
                        <input type="text" id="modal-assigned" value="${sanitizeInput(data.assignedTo || '')}" placeholder="Name">
                    </div>
                    <div>
                        <label for="modal-status">Status:</label>
                        <select id="modal-status">
                            <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Done" ${data.status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                    </div>
                `;
            } else if (type === 'lesson') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-date">Date:</label>
                        <input type="date" id="modal-date" value="${sanitizeInput(data.date || '')}">
                    </div>
                    <div>
                        <label for="modal-name">Teacher Name:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-name" value="${sanitizeInput(data.name || '')}" placeholder="Name" required>
                    </div>
                `;
            } else if (type === 'activity') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-date">Date:</label>
                        <input type="date" id="modal-date" value="${sanitizeInput(data.date || '')}">
                    </div>
                    <div>
                        <label for="modal-desc">Activity:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-desc" value="${sanitizeInput(data.description || '')}" placeholder="Activity description" required>
                    </div>
                    <div>
                        <label for="modal-assigned">Assigned To:</label>
                        <input type="text" id="modal-assigned" value="${sanitizeInput(data.assignedTo || '')}" placeholder="Name(s)">
                    </div>
                `;
            }
            document.getElementById('item-modal').style.display = 'flex';
            document.getElementById('item-modal-error').classList.add('hidden');
        }
        function closeItemModal() {
            document.getElementById('item-modal').style.display = 'none';
            currentModalType = '';
            currentModalIndex = -1;
        }

        // Get Saved Agenda Keys
        function getSavedAgendaKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('agenda_') && key !== 'agenda_draft') {
                    keys.push(key);
                }
            }
            return keys.sort();
        }

        // Populate Load Agenda Dropdown
        function populateLoadAgendaDropdown() {
            const keys = getSavedAgendaKeys();
            loadAgendaSelect.innerHTML = '<option value="">-- Select an Agenda --</option>';
            keys.forEach(key => {
                let displayName = key.replace('agenda_', '');
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data['meeting-date']) {
                        displayName = `Agenda ${data['meeting-date']}`;
                    }
                } catch (e) {
                    console.error('Error parsing stored agenda data:', e);
                }
                const option = document.createElement('option');
                option.value = key;
                option.textContent = displayName;
                loadAgendaSelect.appendChild(option);
            });
        }

        // Clear Dynamic Lists
        function clearDynamicLists() {
            document.getElementById('ministering-assignments-list').innerHTML = '';
            document.getElementById('lessons-list').innerHTML = '';
            document.getElementById('activities-list').innerHTML = '';
            document.getElementById('pending-items-list').innerHTML = '';
            document.getElementById('review-items-list').innerHTML = '';
            ministeringAssignmentCount = 0;
            lessonCount = 0;
            activityCount = 0;
        }

        // Clear Form
        function clearForm() {
            form.reset();
            clearDynamicLists();
            document.getElementById('previous-assignments-display').style.display = 'none';
            localStorage.removeItem('agenda_draft');
            resetValidation();
            showMessage('Form cleared');
        }

        // Sanitize Input
        function sanitizeInput(value) {
            const div = document.createElement('div');
            div.textContent = value || '';
            return div.innerHTML;
        }

        // Add Ministering Assignment
        function addMinisteringAssignment(task = '', assignedTo = '', status = 'Pending', confirmed = false) {
            console.log('Adding ministering assignment:', { task, assignedTo, status, confirmed });
            ministeringAssignmentCount++;
            const list = document.getElementById('ministering-assignments-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `min-assign-${ministeringAssignmentCount}`;
            li.innerHTML = `
                <span>Task: ${sanitizeInput(task)} (Assigned to: ${sanitizeInput(assignedTo || 'N/A')}, Status: ${status})</span>
                <button type="button" class="btn-edit" onclick="openItemModal('assignment', ${ministeringAssignmentCount - 1})" aria-label="Edit assignment"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('min-assign-${ministeringAssignmentCount}')" aria-label="Remove assignment"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Assignment confirmed');
        }

        // Add Lesson
        function addLesson(date = '', name = '', confirmed = false) {
            console.log('Adding lesson:', { date, name, confirmed });
            lessonCount++;
            const list = document.getElementById('lessons-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `lesson-${lessonCount}`;
            li.innerHTML = `
                <span>Date: ${sanitizeInput(date || 'N/A')}, Teacher: ${sanitizeInput(name)}</span>
                <button type="button" class="btn-edit" onclick="openItemModal('lesson', ${lessonCount - 1})" aria-label="Edit lesson"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('lesson-${lessonCount}')" aria-label="Remove lesson"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Lesson confirmed');
        }

        // Add Activity
        function addActivity(date = '', description = '', assignedTo = '', confirmed = false) {
            console.log('Adding activity:', { date, description, assignedTo, confirmed });
            activityCount++;
            const list = document.getElementById('activities-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `activity-${activityCount}`;
            li.innerHTML = `
                <span>Date: ${sanitizeInput(date || 'N/A')}, Activity: ${sanitizeInput(description)}, Assigned to: ${sanitizeInput(assignedTo || 'N/A')}</span>
                <button type="button" class="btn-edit" onclick="openItemModal('activity', ${activityCount - 1})" aria-label="Edit activity"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('activity-${activityCount}')" aria-label="Remove activity"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Activity confirmed');
        }

        // Update Item
        function updateItem(type, index, data) {
            console.log('Updating item:', { type, index, data });
            const formData = getFormData();
            if (type === 'assignment' && formData.ministeringAssignments[index]) {
                formData.ministeringAssignments[index] = {
                    task: data.task,
                    assignedTo: data.assignedTo,
                    status: data.status,
                    confirmed: formData.ministeringAssignments[index].confirmed || false,
                };
                const li = document.getElementById(`min-assign-${index + 1}`);
                li.querySelector('span').textContent = `Task: ${sanitizeInput(data.task)} (Assigned to: ${sanitizeInput(data.assignedTo || 'N/A')}, Status: ${data.status})`;
                showMessage('Assignment updated');
            } else if (type === 'lesson' && formData.lessons[index]) {
                formData.lessons[index] = {
                    date: data.date,
                    name: data.name,
                    confirmed: formData.lessons[index].confirmed || false,
                };
                const li = document.getElementById(`lesson-${index + 1}`);
                li.querySelector('span').textContent = `Date: ${sanitizeInput(data.date || 'N/A')}, Teacher: ${sanitizeInput(data.name)}`;
                showMessage('Lesson updated');
            } else if (type === 'activity' && formData.activities[index]) {
                formData.activities[index] = {
                    date: data.date,
                    description: data.description,
                    assignedTo: data.assignedTo,
                    confirmed: formData.activities[index].confirmed || false,
                };
                const li = document.getElementById(`activity-${index + 1}`);
                li.querySelector('span').textContent = `Date: ${sanitizeInput(data.date || 'N/A')}, Activity: ${sanitizeInput(data.description)}, Assigned to: ${sanitizeInput(data.assignedTo || 'N/A')}`;
                showMessage('Activity updated');
            }
            triggerAutosave();
            updateReviewItems();
        }

        // Remove Dynamic Item
        function removeItem(id) {
            const item = document.getElementById(id);
            if (item) {
                item.remove();
                triggerAutosave();
                updateReviewItems();
                showMessage('Item removed');
            }
        }

        // Update Review Items
        function updateReviewItems() {
            console.log('Updating review items');
            const list = document.getElementById('review-items-list');
            list.innerHTML = '';
            const data = getFormData();

            // Ministering Assignments
            if (data.ministeringAssignments && data.ministeringAssignments.length > 0) {
                const h5 = document.createElement('h5');
                h5.className = 'font-semibold mt-4 mb-2';
                h5.textContent = 'Ministering Assignments';
                list.appendChild(h5);
                data.ministeringAssignments.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'review-item';
                    li.innerHTML = `
                        <input type="checkbox" id="confirm-assign-${index}" ${item.confirmed ? 'checked' : ''} aria-label="Confirm assignment: ${sanitizeInput(item.task)}">
                        <label for="confirm-assign-${index}">Task: ${sanitizeInput(item.task)} (Assigned to: ${sanitizeInput(item.assignedTo || 'N/A')}, Status: ${item.status})</label>
                    `;
                    list.appendChild(li);
                    li.querySelector('input').addEventListener('change', (e) => {
                        data.ministeringAssignments[index].confirmed = e.target.checked;
                        triggerAutosave();
                        showMessage(`Assignment ${e.target.checked ? 'confirmed' : 'unconfirmed'}`);
                    });
                });
            }

            // Lessons
            if (data.lessons && data.lessons.length > 0) {
                const h5 = document.createElement('h5');
                h5.className = 'font-semibold mt-4 mb-2';
                h5.textContent = 'Lessons';
                list.appendChild(h5);
                data.lessons.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'review-item';
                    li.innerHTML = `
                        <input type="checkbox" id="confirm-lesson-${index}" ${item.confirmed ? 'checked' : ''} aria-label="Confirm lesson: ${sanitizeInput(item.name)}">
                        <label for="confirm-lesson-${index}">Date: ${sanitizeInput(item.date || 'N/A')}, Teacher: ${sanitizeInput(item.name)}</label>
                    `;
                    list.appendChild(li);
                    li.querySelector('input').addEventListener('change', (e) => {
                        data.lessons[index].confirmed = e.target.checked;
                        triggerAutosave();
                        showMessage(`Lesson ${e.target.checked ? 'confirmed' : 'unconfirmed'}`);
                    });
                });
            }

            // Activities
            if (data.activities && data.activities.length > 0) {
                const h5 = document.createElement('h5');
                h5.className = 'font-semibold mt-4 mb-2';
                h5.textContent = 'Activities';
                list.appendChild(h5);
                data.activities.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'review-item';
                    li.innerHTML = `
                        <input type="checkbox" id="confirm-activity-${index}" ${item.confirmed ? 'checked' : ''} aria-label="Confirm activity: ${sanitizeInput(item.description)}">
                        <label for="confirm-activity-${index}">Date: ${sanitizeInput(item.date || 'N/A')}, Activity: ${sanitizeInput(item.description)}, Assigned to: ${sanitizeInput(item.assignedTo || 'N/A')}</label>
                    `;
                    list.appendChild(li);
                    li.querySelector('input').addEventListener('change', (e) => {
                        data.activities[index].confirmed = e.target.checked;
                        triggerAutosave();
                        showMessage(`Activity ${e.target.checked ? 'confirmed' : 'unconfirmed'}`);
                    });
                });
            }
        }

        // Get Form Data
        function getFormData() {
            console.log('Collecting form data');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
            data.ministeringAssignments = [];
            document.querySelectorAll('#ministering-assignments-list .dynamic-item').forEach((item, index) => {
                const span = item.querySelector('span').textContent;
                const match = span.match(/Task: (.*) \(Assigned to: (.*), Status: (.*)\)/);
                if (match) {
                    data.ministeringAssignments.push({
                        task: match[1],
                        assignedTo: match[2] === 'N/A' ? '' : match[2],
                        status: match[3],
                        confirmed: document.querySelector(`#confirm-assign-${index}`)?.checked || false,
                    });
                }
            });
            data.lessons = [];
            document.querySelectorAll('#lessons-list .dynamic-item').forEach((item, index) => {
                const span = item.querySelector('span').textContent;
                const match = span.match(/Date: (.*), Teacher: (.*)/);
                if (match) {
                    data.lessons.push({
                        date: match[1] === 'N/A' ? '' : match[1],
                        name: match[2],
                        confirmed: document.querySelector(`#confirm-lesson-${index}`)?.checked || false,
                    });
                }
            });
            data.activities = [];
            document.querySelectorAll('#activities-list .dynamic-item').forEach((item, index) => {
                const span = item.querySelector('span').textContent;
                const match = span.match(/Date: (.*), Activity: (.*), Assigned to: (.*)/);
                if (match) {
                    data.activities.push({
                        date: match[1] === 'N/A' ? '' : match[1],
                        description: match[2],
                        assignedTo: match[3] === 'N/A' ? '' : match[3],
                        confirmed: document.querySelector(`#confirm-activity-${index}`)?.checked || false,
                    });
                }
            });
            console.log('Form data collected:', data);
            return data;
        }

        // Populate Form
        function populateForm(data, showPending = true) {
            console.log('Populating form with data:', data);
            clearForm();
            for (const key in data) {
                if (form.elements[key]) {
                    form.elements[key].value = data[key];
                }
            }
            if (data.ministeringAssignments) {
                data.ministeringAssignments.forEach(item => {
                    addMinisteringAssignment(item.task, item.assignedTo, item.status, item.confirmed);
                });
            }
            if (data.lessons) {
                data.lessons.forEach(item => {
                    addLesson(item.date, item.name, item.confirmed);
                });
            }
            if (data.activities) {
                data.activities.forEach(item => {
                    addActivity(item.date, item.description, item.assignedTo, item.confirmed);
                });
            }
            if (showPending) {
                updatePendingItems();
            } else {
                document.getElementById('previous-assignments-display').style.display = 'none';
            }
        }

        // Update Pending Items
        function updatePendingItems() {
            console.log('Updating pending items');
            const pendingItemsList = document.getElementById('pending-items-list');
            const pendingItemsDisplay = document.getElementById('previous-assignments-display');
            pendingItemsList.innerHTML = '';
            let hasPendingItems = false;
            const keys = getSavedAgendaKeys();
            keys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const meetingDate = data['meeting-date'] || key.replace('agenda_', '');
                    if (data.ministeringAssignments) {
                        data.ministeringAssignments.forEach((item, index) => {
                            if (item.status === 'Pending') {
                                const li = document.createElement('li');
                                li.className = 'pending-item';
                                li.innerHTML = `
                                    <span><i class="fas fa-tasks mr-2"></i>${sanitizeInput(item.task)} (Assigned to: ${sanitizeInput(item.assignedTo || 'N/A')}, Date: ${meetingDate})</span>
                                    <button type="button" class="btn-success" onclick="markPendingDone('${key}', ${index})" aria-label="Mark assignment as done"><i class="fas fa-check mr-1"></i>Mark as Done</button>
                                `;
                                pendingItemsList.appendChild(li);
                                hasPendingItems = true;
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error parsing agenda data:', e);
                }
            });
            pendingItemsDisplay.style.display = hasPendingItems ? 'block' : 'none';
        }

        // Mark Pending Item as Done
        function markPendingDone(agendaKey, index) {
            console.log('Marking pending item as done:', { agendaKey, index });
            try {
                const data = JSON.parse(localStorage.getItem(agendaKey));
                if (data && data.ministeringAssignments[index]) {
                    data.ministeringAssignments[index].status = 'Done';
                    localStorage.setItem(agendaKey, JSON.stringify(data));
                    updatePendingItems();
                    showMessage('Assignment marked as done.');
                } else {
                    showMessage('Assignment not found.', true);
                }
            } catch (e) {
                console.error('Error updating pending item:', e);
                showMessage('Error updating assignment.', true);
            }
        }

        // Validate Form
        function validateForm(data) {
            console.log('Validating form data:', data);
            const errors = [];
            const fields = [
                { id: 'meeting-date', name: 'Meeting Date' },
                { id: 'conducting', name: 'Conducting' },
                { id: 'opening-prayer', name: 'Opening Prayer' },
            ];
            fields.forEach(field => {
                if (!data[field.id]) {
                    errors.push(`${field.name} is required.`);
                }
            });
            return errors;
        }

        // Validate Modal
        function validateModal(type) {
            if (type === 'assignment') {
                const task = document.getElementById('modal-task').value;
                return task.trim() !== '';
            } else if (type === 'lesson') {
                const name = document.getElementById('modal-name').value;
                return name.trim() !== '';
            } else if (type === 'activity') {
                const desc = document.getElementById('modal-desc').value;
                return desc.trim() !== '';
            }
            return true;
        }

        // Reset Validation UI
        function resetValidation() {
            const fields = ['meeting-date', 'conducting', 'opening-prayer'];
            fields.forEach(id => {
                const input = document.getElementById(id);
                const error = document.getElementById(`${id}-error`);
                input.classList.remove('error-border');
                error.classList.add('hidden');
            });
        }

        // Show Validation Errors
        function showValidationErrors(errors) {
            resetValidation();
            errors.forEach(error => {
                const fieldId = error.includes('Meeting Date') ? 'meeting-date' :
                               error.includes('Conducting') ? 'conducting' :
                               error.includes('Opening Prayer') ? 'opening-prayer' : null;
                if (fieldId) {
                    const input = document.getElementById(fieldId);
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    input.classList.add('error-border');
                    errorEl.classList.remove('hidden');
                }
            });
        }

        // Save Agenda
        function saveAgenda() {
            console.log('Saving agenda');
            const data = getFormData();
            const errors = validateForm(data);
            if (errors.length > 0) {
                showValidationErrors(errors);
                showMessage(errors.join(' '), true);
                return;
            }
            const key = `agenda_${data['meeting-date']}`;
            try {
                localStorage.setItem(key, JSON.stringify(data));
                localStorage.removeItem('agenda_draft');
                showMessage(`Agenda for ${data['meeting-date']} saved successfully!`);
                resetValidation();
                updatePendingItems();
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showMessage('Error saving agenda. Storage might be full.', true);
            }
        }

        // Autosave
        function triggerAutosave() {
            console.log('Triggering autosave');
            clearTimeout(autosaveTimeout);
            autosaveTimeout = setTimeout(() => {
                const data = getFormData();
                if (data['meeting-date']) {
                    try {
                        localStorage.setItem('agenda_draft', JSON.stringify(data));
                        showMessage('Draft saved');
                    } catch (e) {
                        console.error('Error autosaving draft:', e);
                        showMessage('Error saving draft.', true);
                    }
                }
            }, 1000);
        }

        // Load Agenda
        function loadAgenda() {
            console.log('Loading agenda');
            const selectedKey = loadAgendaSelect.value;
            if (!selectedKey) {
                showMessage('Please select an agenda to load.', true);
                return;
            }
            try {
                const dataString = localStorage.getItem(selectedKey);
                if (dataString) {
                    const data = JSON.parse(dataString);
                    populateForm(data, false);
                    showMessage(`Loaded agenda: ${selectedKey.replace('agenda_', '')}`);
                    closeLoadModal();
                } else {
                    showMessage('Could not find saved data for this agenda.', true);
                }
            } catch (e) {
                console.error('Error loading agenda:', e);
                showMessage('Error loading agenda.', true);
            }
        }

        // Create New Agenda
        function createNewAgenda() {
            console.log('Creating new agenda');
            const currentData = getFormData();
            const errors = validateForm(currentData);
            if (errors.length > 0) {
                showValidationErrors(errors);
                showMessage('Please complete required fields before creating a new agenda.', true);
                return;
            }
            const ideas = [];
            if (currentData['skills-ideas']) ideas.push(`- Skills/Service: ${currentData['skills-ideas']}`);
            if (currentData['sunday-discussion']) ideas.push(`- Sunday Discussion: ${currentData['sunday-discussion']}`);
            if (currentData['temple-history']) ideas.push(`- Temple & Family History: ${currentData['temple-history']}`);
            if (currentData['spirit-unity']) ideas.push(`- Spirit & Unity: ${currentData['spirit-unity']}`);
            const previousIdeas = ideas.length > 0 ? ideas.join('\n') : '';
            clearForm();
            const lastDateStr = currentData['meeting-date'];
            if (lastDateStr) {
                try {
                    const lastDate = new Date(lastDateStr + 'T00:00:00');
                    if (!isNaN(lastDate.getTime())) {
                        lastDate.setDate(lastDate.getDate() + 7);
                        const year = lastDate.getFullYear();
                        const month = String(lastDate.getMonth() + 1).padStart(2, '0');
                        const day = String(lastDate.getDate()).padStart(2, '0');
                        form.elements['meeting-date'].value = `${year}-${month}-${day}`;
                    }
                } catch (e) {
                    console.error('Error calculating next date:', e);
                }
            }
            form.elements['previous-ideas'].value = previousIdeas;
            updatePendingItems();
            showMessage('New agenda created. Pending assignments and ideas carried over.');
            document.querySelector('details:nth-of-type(2)').open = true;
        }

        // Export as PDF
        function exportAsPDF() {
            console.log('Exporting as PDF');
            if (!jsPDF) {
                showMessage('PDF library not loaded. Please try again.', true);
                return;
            }
            const data = getFormData();
            const errors = validateForm(data);
            if (errors.length > 0) {
                showValidationErrors(errors);
                showMessage('Please complete required fields before exporting.', true);
                return;
            }
            try {
                const doc = new jsPDF();
                let y = 10;
                const pageHeight = doc.internal.pageSize.height;
                const maxWidth = 180;

                function addText(text, x, y, options = {}) {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = 10;
                    }
                    doc.text(text, x, y, options);
                    return y + (options.maxWidth ? doc.getTextDimensions(text, options).h : 7);
                }

                doc.setFontSize(16);
                y = addText('Presidency Meeting Agenda', 10, y);
                doc.setFontSize(12);
                y = addText(`Date: ${data['meeting-date'] || 'N/A'}`, 10, y);
                y = addText(`Conducting: ${data['conducting'] || 'N/A'}`, 10, y);
                y = addText(`Opening Prayer: ${data['opening-prayer'] || 'N/A'}`, 10, y);
                y += 5;

                doc.setFontSize(14);
                y = addText('Follow-Up', 10, y);
                doc.setFontSize(12);
                y = addText(data['follow-up-notes'] || 'No notes', 10, y, { maxWidth });
                if (data['previous-ideas']) {
                    y = addText('Ideas from Previous Meeting:', 10, y);
                    y = addText(data['previous-ideas'], 15, y, { maxWidth });
                }
                const pendingItems = [];
                getSavedAgendaKeys().forEach(key => {
                    const agendaData = JSON.parse(localStorage.getItem(key));
                    const meetingDate = agendaData['meeting-date'] || key.replace('agenda_', '');
                    if (agendaData.ministeringAssignments) {
                        agendaData.ministeringAssignments.forEach(item => {
                            if (item.status === 'Pending') {
                                pendingItems.push(`- ${item.task || 'No task'} (Assigned to: ${item.assignedTo || 'N/A'}, Date: ${meetingDate})`);
                            }
                        });
                    }
                });
                if (pendingItems.length > 0) {
                    y = addText('Pending Assignments:', 10, y);
                    pendingItems.forEach(item => {
                        y = addText(item, 15, y, { maxWidth });
                    });
                } else {
                    y = addText('No pending assignments', 15, y);
                }

                doc.setFontSize(14);
                y = addText('Ministering', 10, y);
                doc.setFontSize(12);
                y = addText(data['ministering-discussion'] || 'No notes', 10, y, { maxWidth });
                if (data.ministeringAssignments && data.ministeringAssignments.length > 0) {
                    data.ministeringAssignments.forEach(item => {
                        const text = `- ${item.task || 'No task'} (Assigned to: ${item.assignedTo || 'N/A'}, Status: ${item.status || 'N/A'})`;
                        y = addText(text, 15, y);
                    });
                } else {
                    y = addText('No assignments', 15, y);
                }

                doc.setFontSize(14);
                y = addText('Review & Closing', 10, y);
                doc.setFontSize(12);
                if (data.ministeringAssignments && data.ministeringAssignments.length > 0) {
                    y = addText('Ministering Assignments:', 10, y);
                    data.ministeringAssignments.forEach(item => {
                        const text = `- ${item.task || 'No task'} (Assigned to: ${item.assignedTo || 'N/A'}, Status: ${item.status || 'N/A'}, Confirmed: ${item.confirmed ? 'Yes' : 'No'})`;
                        y = addText(text, 15, y);
                    });
                }
                if (data.lessons && data.lessons.length > 0) {
                    y = addText('Lessons:', 10, y);
                    data.lessons.forEach(item => {
                        const text = `- Date: ${item.date || 'N/A'}, Teacher: ${item.name || 'N/A'}, Confirmed: ${item.confirmed ? 'Yes' : 'No'}`;
                        y = addText(text, 15, y);
                    });
                }
                if (data.activities && data.activities.length > 0) {
                    y = addText('Activities:', 10, y);
                    data.activities.forEach(item => {
                        const text = `- Date: ${item.date || 'N/A'}, Activity: ${item.description || 'N/A'}, Assigned to: ${item.assignedTo || 'N/A'}, Confirmed: ${item.confirmed ? 'Yes' : 'No'}`;
                        y = addText(text, 15, y);
                    });
                }
                if (!data.ministeringAssignments?.length && !data.lessons?.length && !data.activities?.length) {
                    y = addText('No items for review', 15, y);
                }
                y = addText(`Closing Prayer: ${data['closing-prayer'] || 'N/A'}`, 10, y);

                doc.save(`Agenda_${data['meeting-date'] || 'untitled'}.pdf`);
                showMessage('Agenda exported as PDF.');
            } catch (e) {
                console.error('Error exporting PDF:', e);
                showMessage('Error exporting PDF.', true);
            }
        }

        // Accordion Behavior
        function setupAccordion() {
            const accordionToggle = document.getElementById('accordion-toggle');
            const detailsElements = document.querySelectorAll('details');
            detailsElements.forEach(detail => {
                detail.addEventListener('toggle', () => {
                    if (accordionToggle.checked && window.innerWidth < 640 && detail.open) {
                        detailsElements.forEach(other => {
                            if (other !== detail) other.open = false;
                        });
                    }
                });
            });
        }

        // Modal Confirm
        function confirmItem() {
            console.log('Confirming item:', { type: currentModalType, index: currentModalIndex });
            if (!validateModal(currentModalType)) {
                document.getElementById('item-modal-error').classList.remove('hidden');
                return;
            }
            if (currentModalType === 'assignment') {
                const task = document.getElementById('modal-task').value;
                const assignedTo = document.getElementById('modal-assigned').value;
                const status = document.getElementById('modal-status').value;
                if (currentModalIndex === -1) {
                    addMinisteringAssignment(task, assignedTo, status);
                } else {
                    updateItem('assignment', currentModalIndex, { task, assignedTo, status });
                }
            } else if (currentModalType === 'lesson') {
                const date = document.getElementById('modal-date').value;
                const name = document.getElementById('modal-name').value;
                if (currentModalIndex === -1) {
                    addLesson(date, name);
                } else {
                    updateItem('lesson', currentModalIndex, { date, name });
                }
            } else if (currentModalType === 'activity') {
                const date = document.getElementById('modal-date').value;
                const description = document.getElementById('modal-desc').value;
                const assignedTo = document.getElementById('modal-assigned').value;
                if (currentModalIndex === -1) {
                    addActivity(date, description, assignedTo);
                } else {
                    updateItem('activity', currentModalIndex, { date, description, assignedTo });
                }
            }
            closeItemModal();
        }

        // Event Listeners
        document.getElementById('save-button').addEventListener('click', saveAgenda);
        document.getElementById('mobile-save-button').addEventListener('click', saveAgenda);
        document.getElementById('create-new-button').addEventListener('click', createNewAgenda);
        document.getElementById('mobile-create-new-button').addEventListener('click', createNewAgenda);
        document.getElementById('export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('mobile-export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('clear-button').addEventListener('click', clearForm);
        document.getElementById('mobile-clear-button').addEventListener('click', clearForm);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('view-past-button').addEventListener('click', openLoadModal);
        document.getElementById('load-button').addEventListener('click', loadAgenda);
        document.getElementById('close-modal-button').addEventListener('click', closeLoadModal);
        document.getElementById('item-modal-confirm').addEventListener('click', confirmItem);
        document.getElementById('item-modal-cancel').addEventListener('click', closeItemModal);
        form.addEventListener('input', triggerAutosave);
        form.addEventListener('change', triggerAutosave);

        // Initial Setup
        window.addEventListener('load', () => {
            console.log('Initializing app');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            if (!form.elements['meeting-date'].value) {
                form.elements['meeting-date'].value = `${year}-${month}-${day}`;
            }
            document.getElementById('meeting-date').focus();
            document.getElementById('previous-assignments-display').style.display = 'none';
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            const draft = localStorage.getItem('agenda_draft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    populateForm(data);
                    showMessage('Loaded draft from last session.');
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
            updatePendingItems();
            setupAccordion();
        });
    </script>
</body>
</html>
