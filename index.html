<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidency Agenda Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #1f2937;
        }
        summary {
            cursor: pointer;
            padding: 1rem;
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }
        .dark summary {
            background-color: #6366f1;
        }
        summary:hover {
            background-color: #4338ca;
        }
        .dark summary:hover {
            background-color: #4f46e5;
        }
        summary::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.3s ease-in-out;
            margin-left: 0.5rem;
        }
        details[open] > summary::after {
            transform: rotate(180deg);
        }
        details > div {
            padding: 1.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .dark details > div {
            background-color: #374151;
            border-color: #4b5563;
        }
        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .dark input[type="text"],
        .dark input[type="date"],
        .dark textarea,
        .dark select {
            background-color: #4b5563;
            border-color: #6b7280;
            color: white;
        }
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        .error-border {
            border-color: #ef4444;
        }
        textarea {
            min-height: 100px;
        }
        label {
            font-weight: 500;
            color: #374151;
        }
        .dark label {
            color: #d1d5db;
        }
        .helper-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
        }
        .error-text {
            color: #ef4444;
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-width: 48px;
            min-height: 48px;
        }
        button:hover {
            transform: scale(1.05);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-edit {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .btn-edit:hover {
            background-color: #4b5563;
        }
        .dynamic-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .dark .dynamic-item {
            background-color: #4b5563;
        }
        .checked-item {
            color: #6b7280;
        }
        .dark .checked-item {
            color: #9ca3af;
        }
        .checked-item {
            text-decoration: line-through;
        }
        
        #message-box {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #message-box.error {
            background-color: #ef4444;
        }
        #message-box.show {
            opacity: 1;
        }
        #action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }
        .dark #action-buttons {
            background-color: #1f2937;
        }
        #load-modal, #item-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        #load-modal-content, #item-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .dark #load-modal-content, .dark #item-modal-content {
            background-color: #374151;
        }
        @media (max-width: 640px) {
            #action-buttons {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
            .max-w-2xl {
                max-width: 100%;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            button[title]:hover::after {
                content: attr(title);
                position: absolute;
                background-color: #374151;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                white-space: nowrap;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Presidency Meeting Agenda</h1>
            <button id="theme-toggle" class="btn-secondary" title="Toggle Dark Mode" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="mb-6">
            <button id="view-past-button" class="btn-secondary" aria-label="View past agendas"><i class="fas fa-history mr-1"></i> View Past Agendas</button>
        </div>

        <div class="mb-6 flex items-center">
            <label for="accordion-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Accordion Mode (Mobile):</label>
            <input type="checkbox" id="accordion-toggle" checked class="h-5 w-5">
        </div>

        <form id="agenda-form">
            <details class="mb-4" open>
                <summary>Meeting Details</summary>
                <div class="space-y-4">
                    <div>
                        <label for="meeting-date">Date:</label>
                        <input type="date" id="meeting-date" name="meeting-date" required autocomplete="off">
                        <p class="helper-text error-text hidden" id="meeting-date-error">Required</p>
                    </div>
                    <div>
                        <label for="conducting">Conducting:</label>
                        <input type="text" id="conducting" name="conducting" placeholder="Name of person conducting" autocomplete="name" required>
                        <p class="helper-text error-text hidden" id="conducting-error">Required</p>
                    </div>
                    <div>
                        <label for="opening-prayer">Opening Prayer:</label>
                        <input type="text" id="opening-prayer" name="opening-prayer" placeholder="Name of person praying" autocomplete="name" required>
                        <p class="helper-text error-text hidden" id="opening-prayer-error">Required</p>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Follow-Up</summary>
                <div class="space-y-4">
                    <div id="previous-assignments-display" class="text-gray-800 dark:text-white">
                        <h4 class="font-semibold mb-2">Ideas from Previous Meeting:</h4>
                        <ul id="previous-ideas-list" class="list-none pl-5" aria-label="Ideas from previous meeting"></ul>
                        <h4 class="font-semibold mt-4 mb-2">Assignments from Previous Meeting:</h4>
                        <ul id="previous-items-list" class="list-none pl-5" aria-label="Assignments from previous meeting"></ul>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Ministering</summary>
                <div>
                    <label for="ministering-discussion">How can we invite and help our quorum or class come unto Christ? Support them and others?</label>
                    <textarea id="ministering-discussion" name="ministering-discussion" placeholder="Discussion notes..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Assignments:</h4>
                    <ul id="ministering-assignments-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('assignment', -1)" class="btn-secondary text-sm" aria-label="Add a new ministering assignment"><i class="fas fa-plus mr-1"></i> Add Assignment</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Sunday Quorum/Class Meetings</summary>
                <div>
                    <label for="sunday-discussion">What to discuss with quorum/class members? (Ref: "Counsel Together")</label>
                    <textarea id="sunday-discussion" name="sunday-discussion" placeholder="Discussion points for Sunday..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Upcoming Lessons:</h4>
                    <ul id="lessons-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('lesson', -1)" class="btn-secondary text-sm" aria-label="Add a new lesson"><i class="fas fa-plus mr-1"></i> Add Lesson</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Service & Activities</summary>
                <div>
                    <label for="skills-ideas">Skills to learn/develop? How to serve others?</label>
                    <textarea id="skills-ideas" name="skills-ideas" placeholder="Brainstorm ideas..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Planned Service/Activities:</h4>
                    <ul id="activities-list" class="list-disc pl-5"></ul>
                    <button type="button" onclick="openItemModal('activity', -1)" class="btn-secondary text-sm" aria-label="Add a new activity"><i class="fas fa-plus mr-1"></i> Add Activity</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Other Discussion Items</summary>
                <div class="space-y-4">
                    <div>
                        <label for="temple-history">Temple & Family History / Sharing the Gospel:</label>
                        <textarea id="temple-history" name="temple-history" placeholder="Notes on participation..."></textarea>
                    </div>
                    <div>
                        <label for="spirit-unity">Inviting the Spirit / Fostering Unity:</label>
                        <textarea id="spirit-unity" name="spirit-unity" placeholder="Ideas and plans..."></textarea>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Leadership Instruction</summary>
                <div>
                    <label for="leadership-instruction">Notes from Bishopric Member or Adult Adviser:</label>
                    <textarea id="leadership-instruction" name="leadership-instruction" placeholder="Record instructions given..."></textarea>
                </div>
            </details>

            <details class="mb-4">
                <summary>Review & Closing</summary>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">Items for Review:</h4>
                        <div id="review-items-list"></div>
                    </div>
                    <div>
                        <label for="closing-prayer">Closing Prayer:</label>
                        <input type="text" id="closing-prayer" name="closing-prayer" placeholder="Name of person praying" autocomplete="name">
                    </div>
                </div>
            </details>

            <div class="mt-8 flex flex-wrap justify-center gap-4" id="desktop-buttons">
                <button type="button" id="save-button" class="btn-primary" aria-label="Save the current agenda"><i class="fas fa-save mr-1"></i> Save Agenda</button>
                <button type="button" id="create-new-button" class="btn-success" aria-label="Create a new agenda"><i class="fas fa-plus mr-1"></i> Create New Agenda</button>
                <button type="button" id="export-pdf-button" class="btn-primary" aria-label="Export agenda as PDF"><i class="fas fa-file-pdf mr-1"></i> Export as PDF</button>
                <button type="button" id="clear-button" class="btn-secondary" aria-label="Clear the form"><i class="fas fa-eraser mr-1"></i> Clear Form</button>
            </div>
        </form>

        <div id="action-buttons" class="hidden sm:hidden">
            <button type="button" id="mobile-save-button" class="btn-primary" title="Save Agenda" aria-label="Save the current agenda"><i class="fas fa-save"></i></button>
            <button type="button" id="mobile-create-new-button" class="btn-success" title="Create New Agenda" aria-label="Create a new agenda"><i class="fas fa-plus"></i></button>
            <button type="button" id="mobile-export-pdf-button" class="btn-primary" title="Export as PDF" aria-label="Export agenda as PDF"><i class="fas fa-file-pdf"></i></button>
            <button type="button" id="mobile-clear-button" class="btn-secondary" title="Clear Form" aria-label="Clear the form"><i class="fas fa-eraser"></i></button>
        </div>
    </div>

    <div id="load-modal">
        <div id="load-modal-content">
            <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Load Past Agenda</h2>
            <div class="flex mb-4">
                <select id="load-agenda" class="flex-grow">
                    <option value="">-- Select an Agenda --</option>
                </select>
                <button id="load-button" class="btn-primary ml-2" aria-label="Load selected agenda">Load</button>
            </div>
            <button id="close-modal-button" class="btn-secondary w-full" aria-label="Close modal">Close</button>
        </div>
    </div>

    <div id="item-modal">
        <div id="item-modal-content">
            <h2 id="item-modal-title" class="text-lg font-semibold mb-4 text-gray-800 dark:text-white"></h2>
            <form id="item-modal-form" class="space-y-4"></form>
            <p id="item-modal-error" class="helper-text error-text hidden">Please fill in all required fields.</p>
            <div class="flex gap-4 mt-4">
                <button type="button" id="item-modal-confirm" class="btn-primary flex-grow" aria-label="Confirm item">Confirm</button>
                <button type="button" id="item-modal-cancel" class="btn-secondary flex-grow" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="message-box"><i id="message-icon" class="fas"></i><span id="message-text"></span></div>

    <script>
        const { jsPDF } = window.jspdf || {};
        const form = document.getElementById('agenda-form');
        const loadAgendaSelect = document.getElementById('load-agenda');
        const messageBox = document.getElementById('message-box');
        const messageIcon = document.getElementById('message-icon');
        const messageText = document.getElementById('message-text');
        let messageTimeout;
        let ministeringAssignmentCount = 0;
        let lessonCount = 0;
        let activityCount = 0;
        let autosaveTimeout;
        let currentModalType = '';
        let currentModalIndex = -1;

        // Theme Handling
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // Show Message
        function showMessage(message, isError = false, duration = 4000) {
            console.log(`${isError ? 'Error' : 'Message'}: ${message}`);
            messageText.textContent = message;
            messageIcon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}`;
            messageBox.classList.remove('error');
            if (isError) messageBox.classList.add('error');
            messageBox.classList.add('show');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Modal Handling
        function openLoadModal() {
            document.getElementById('load-modal').style.display = 'flex';
            populateLoadAgendaDropdown();
        }
        function closeLoadModal() {
            document.getElementById('load-modal').style.display = 'none';
        }

        function openItemModal(type, index) {
            console.log('Opening item modal:', { type, index });
            currentModalType = type;
            currentModalIndex = index;
            const modalTitle = document.getElementById('item-modal-title');
            const modalForm = document.getElementById('item-modal-form');
            const isEdit = index !== -1;
            modalTitle.textContent = isEdit ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            modalForm.innerHTML = '';

            let data = {};
            if (isEdit) {
                const formData = getFormData();
                if (type === 'assignment') data = formData.ministeringAssignments[index] || {};
                else if (type === 'lesson') data = formData.lessons[index] || {};
                else if (type === 'activity') data = formData.activities[index] || {};
            }

            if (type === 'assignment') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-task">Task:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-task" value="${sanitizeInput(data.task || '')}" placeholder="Assignment description" required>
                    </div>
                    <div>
                        <label for="modal-assigned">Assigned To:</label>
                        <input type="text" id="modal-assigned" value="${sanitizeInput(data.assignedTo || '')}" placeholder="Name">
                    </div>
                    <div>
                        <label for="modal-status">Status:</label>
                        <select id="modal-status">
                            <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Done" ${data.status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                    </div>
                `;
            } else if (type === 'lesson') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-date">Date:</label>
                        <input type="date" id="modal-date" value="${sanitizeInput(data.date || '')}">
                    </div>
                    <div>
                        <label for="modal-name">Teacher Name:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-name" value="${sanitizeInput(data.name || '')}" placeholder="Name" required>
                    </div>
                `;
            } else if (type === 'activity') {
                modalForm.innerHTML = `
                    <div>
                        <label for="modal-date">Date:</label>
                        <input type="date" id="modal-date" value="${sanitizeInput(data.date || '')}">
                    </div>
                    <div>
                        <label for="modal-desc">Activity:<span class="text-red-500">*</span></label>
                        <input type="text" id="modal-desc" value="${sanitizeInput(data.description || '')}" placeholder="Activity description" required>
                    </div>
                    <div>
                        <label for="modal-assigned">Assigned To:</label>
                        <input type="text" id="modal-assigned" value="${sanitizeInput(data.assignedTo || '')}" placeholder="Name(s)">
                    </div>
                `;
            }
            document.getElementById('item-modal').style.display = 'flex';
            document.getElementById('item-modal-error').classList.add('hidden');
        }
        function closeItemModal() {
            document.getElementById('item-modal').style.display = 'none';
            currentModalType = '';
            currentModalIndex = -1;
        }

        // Get Saved Agenda Keys
        function getSavedAgendaKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('agenda_') && key !== 'agenda_draft') {
                    keys.push(key);
                }
            }
            return keys.sort();
        }

        // Get Previous Agenda Key
        function getPreviousAgendaKey(currentDate) {
            console.log('Finding previous agenda key for date:', currentDate);
            const keys = getSavedAgendaKeys();
            if (!currentDate) return null;
            const currentDateObj = new Date(currentDate + 'T00:00:00');
            let previousKey = null;
            let latestDate = null;
            keys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const agendaDate = data['meeting-date'];
                    if (agendaDate && agendaDate < currentDate) {
                        const agendaDateObj = new Date(agendaDate + 'T00:00:00');
                        if (!latestDate || agendaDateObj > latestDate) {
                            latestDate = agendaDateObj;
                            previousKey = key;
                        }
                    }
                } catch (e) {
                    console.error('Error parsing agenda date:', e);
                }
            });
            console.log('Previous agenda key:', previousKey);
            return previousKey;
        }

        // Populate Load Agenda Dropdown
        function populateLoadAgendaDropdown() {
            const keys = getSavedAgendaKeys();
            loadAgendaSelect.innerHTML = '<option value="">-- Select an Agenda --</option>';
            keys.forEach(key => {
                let displayName = key.replace('agenda_', '');
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data['meeting-date']) {
                        displayName = `Agenda ${data['meeting-date']}`;
                    }
                } catch (e) {
                    console.error('Error parsing stored agenda data:', e);
                }
                const option = document.createElement('option');
                option.value = key;
                option.textContent = displayName;
                loadAgendaSelect.appendChild(option);
            });
        }

        // Clear Dynamic Lists
        function clearDynamicLists() {
            document.getElementById('ministering-assignments-list').innerHTML = '';
            document.getElementById('lessons-list').innerHTML = '';
            document.getElementById('activities-list').innerHTML = '';
            document.getElementById('previous-ideas-list').innerHTML = '';
            document.getElementById('previous-items-list').innerHTML = '';
            document.getElementById('review-items-list').innerHTML = '';
            ministeringAssignmentCount = 0;
            lessonCount = 0;
            activityCount = 0;
        }

        // Clear Form
        function clearForm() {
            form.reset();
            clearDynamicLists();
            document.getElementById('previous-assignments-display').style.display = 'none';
            localStorage.removeItem('agenda_draft');
            resetValidation();
            showMessage('Form cleared');
        }

        // Sanitize Input
        function sanitizeInput(value) {
            const div = document.createElement('div');
            div.textContent = value || '';
            return div.innerHTML;
        }

        // Add Ministering Assignment
        function addMinisteringAssignment(task = '', assignedTo = '', status = 'Pending', confirmed = false) {
            console.log('Adding ministering assignment:', { task, assignedTo, status, confirmed });
            ministeringAssignmentCount++;
            const list = document.getElementById('ministering-assignments-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `min-assign-${ministeringAssignmentCount}`;
            li.innerHTML = `
                <span>Task: ${sanitizeInput(task)} (Assigned to: ${sanitizeInput(assignedTo || 'N/A')}, Status: ${status})</span>
                <button type="button" class="btn-edit" onclick="openItemModal('assignment', ${ministeringAssignmentCount - 1})" aria-label="Edit assignment"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('min-assign-${ministeringAssignmentCount}')" aria-label="Remove assignment"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Assignment confirmed');
        }

        // Add Lesson
        function addLesson(date = '', name = '', confirmed = false) {
            console.log('Adding lesson:', { date, name, confirmed });
            lessonCount++;
            const list = document.getElementById('lessons-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `lesson-${lessonCount}`;
            li.innerHTML = `
                <span>Lesson - Date: ${sanitizeInput(date || 'N/A')}, Teacher: ${sanitizeInput(name)}</span>
                <button type="button" class="btn-edit" onclick="openItemModal('lesson', ${lessonCount - 1})" aria-label="Edit lesson"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('lesson-${lessonCount}')" aria-label="Remove lesson"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Lesson confirmed');
        }

        // Add Activity
        function addActivity(date = '', description = '', assignedTo = '', confirmed = false) {
            console.log('Adding activity:', { date, description, assignedTo, confirmed });
            activityCount++;
            const list = document.getElementById('activities-list');
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.id = `activity-${activityCount}`;
            li.innerHTML = `
                <span>Activity - Date: ${sanitizeInput(date || 'N/A')}, Description: ${sanitizeInput(description)}, Assigned to: ${sanitizeInput(assignedTo || 'N/A')}</span>
                <button type="button" class="btn-edit" onclick="openItemModal('activity', ${activityCount - 1})" aria-label="Edit activity"><i class="fas fa-edit"></i></button>
                <button type="button" class="btn-danger" onclick="removeItem('activity-${activityCount}')" aria-label="Remove activity"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(li);
            triggerAutosave();
            updateReviewItems();
            showMessage('Activity confirmed');
        }

        // Update Item
        function updateItem(type, index, data) {
            console.log('Updating item:', { type, index, data });
            const formData = getFormData();
            if (type === 'assignment' && formData.ministeringAssignments[index]) {
                formData.ministeringAssignments[index] = {
                    task: data.task,
                    assignedTo: data.assignedTo,
                    status: data.status,
                    confirmed: formData.ministeringAssignments[index].confirmed || false,
                };
                const li = document.getElementById(`min-assign-${index + 1}`);
                li.querySelector('span').textContent = `Task: ${sanitizeInput(data.task)} (Assigned to: ${sanitizeInput(data.assignedTo || 'N/A')}, Status: ${data.status})`;
                showMessage('Assignment updated');
            } else if (type === 'lesson' && formData.lessons[index]) {
                formData.lessons[index] = {
                    date: data.date,
                    name: data.name,
                    confirmed: formData.lessons[index].confirmed || false,
                };
                const li = document.getElementById(`lesson-${index + 1}`);
                li.querySelector('span').textContent = `Lesson - Date: ${sanitizeInput(data.date || 'N/A')}, Teacher: ${sanitizeInput(data.name)}`;
                showMessage('Lesson updated');
            } else if (type === 'activity' && formData.activities[index]) {
                formData.activities[index] = {
                    date: data.date,
                    description: data.description,
                    assignedTo: data.assignedTo,
                    confirmed: formData.activities[index].confirmed || false,
                };
                const li = document.getElementById(`activity-${index + 1}`);
                li.querySelector('span').textContent = `Activity - Date: ${sanitizeInput(data.date || 'N/A')}, Description: ${sanitizeInput(data.description)}, Assigned to: ${sanitizeInput(data.assignedTo || 'N/A')}`;
                showMessage('Activity updated');
            }
            triggerAutosave();
            updateReviewItems();
        }

        // Remove Item
        function removeItem(id) {
            console.log('Removing item:', id);
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                triggerAutosave();
                updateReviewItems();
                showMessage('Item removed');
            }
        }

        // Get Form Data
        function getFormData() {
            const data = {
                'meeting-date': document.getElementById('meeting-date').value,
                'conducting': document.getElementById('conducting').value,
                'opening-prayer': document.getElementById('opening-prayer').value,
                'ministering-discussion': document.getElementById('ministering-discussion').value,
                'sunday-discussion': document.getElementById('sunday-discussion').value,
                'skills-ideas': document.getElementById('skills-ideas').value,
                'temple-history': document.getElementById('temple-history').value,
                'spirit-unity': document.getElementById('spirit-unity').value,
                'leadership-instruction': document.getElementById('leadership-instruction').value,
                'closing-prayer': document.getElementById('closing-prayer').value,
                ministeringAssignments: [],
                lessons: [],
                activities: [],
                followUpStatus: {},
            };
            for (let i = 1; i <= ministeringAssignmentCount; i++) {
                const li = document.getElementById(`min-assign-${i}`);
                if (li) {
                    const text = li.querySelector('span').textContent;
                    const match = text.match(/Task: (.*) \(Assigned to: (.*), Status: (.*)\)/);
                    if (match) {
                        data.ministeringAssignments.push({
                            task: match[1],
                            assignedTo: match[2] === 'N/A' ? '' : match[2],
                            status: match[3],
                            confirmed: true,
                        });
                    }
                }
            }
            for (let i = 1; i <= lessonCount; i++) {
                const li = document.getElementById(`lesson-${i}`);
                if (li) {
                    const text = li.querySelector('span').textContent;
                    const match = text.match(/Lesson - Date: (.*), Teacher: (.*)/);
                    if (match) {
                        data.lessons.push({
                            date: match[1] === 'N/A' ? '' : match[1],
                            name: match[2],
                            confirmed: true,
                        });
                    }
                }
            }
            for (let i = 1; i <= activityCount; i++) {
                const li = document.getElementById(`activity-${i}`);
                if (li) {
                    const text = li.querySelector('span').textContent;
                    const match = text.match(/Activity - Date: (.*), Description: (.*), Assigned to: (.*)/);
                    if (match) {
                        data.activities.push({
                            date: match[1] === 'N/A' ? '' : match[1],
                            description: match[2],
                            assignedTo: match[3] === 'N/A' ? '' : match[3],
                            confirmed: true,
                        });
                    }
                }
            }
            const checkboxes = document.querySelectorAll('#previous-ideas-list input[type="checkbox"], #previous-items-list input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                data.followUpStatus[checkbox.dataset.id] = checkbox.checked;
            });
            return data;
        }

        // Update Previous Ideas
        function updatePreviousIdeas() {
            console.log('Updating previous ideas');
            const previousIdeasList = document.getElementById('previous-ideas-list');
            previousIdeasList.innerHTML = '';
            const currentDate = document.getElementById('meeting-date').value;
            const previousKey = getPreviousAgendaKey(currentDate);
            const formData = getFormData();
            const followUpStatus = formData.followUpStatus || {};
            if (!previousKey) {
                console.log('No previous agenda found');
                return;
            }
            try {
                const previousData = JSON.parse(localStorage.getItem(previousKey));
                const ideas = [
                    { id: 'skills', label: 'Skills/Service', value: previousData['skills-ideas'] },
                    { id: 'sunday', label: 'Sunday Discussion', value: previousData['sunday-discussion'] },
                    { id: 'temple', label: 'Temple & Family History', value: previousData['temple-history'] },
                    { id: 'spirit', label: 'Spirit/Unity', value: previousData['spirit-unity'] },
                ];
                let hasItems = false;
                ideas.forEach((idea, index) => {
                    if (idea.value) {
                        const li = document.createElement('li');
                        li.className = 'dynamic-item';
                        const dataId = `idea-${idea.id}-${index + 1}`;
                        const isChecked = followUpStatus[dataId] || false;
                        li.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" data-id="${dataId}" ${isChecked ? 'checked' : ''} aria-label="Check off idea: ${idea.label}">
                                <span class="${isChecked ? 'checked-item' : ''}">${idea.label}: ${sanitizeInput(idea.value)}</span>
                            </label>
                        `;
                        previousIdeasList.appendChild(li);
                        hasItems = true;
                    }
                });
                document.getElementById('previous-assignments-display').style.display = hasItems || document.getElementById('previous-items-list').children.length > 0 ? 'block' : 'none';
            } catch (e) {
                console.error('Error updating previous ideas:', e);
            }
        }

        // Update Previous Items
        function updatePreviousItems() {
            console.log('Updating previous items');
            const previousItemsList = document.getElementById('previous-items-list');
            previousItemsList.innerHTML = '';
            const currentDate = document.getElementById('meeting-date').value;
            const previousKey = getPreviousAgendaKey(currentDate);
            const formData = getFormData();
            const followUpStatus = formData.followUpStatus || {};
            let hasItems = false;
            if (previousKey) {
                try {
                    const previousData = JSON.parse(localStorage.getItem(previousKey));
                    previousData.ministeringAssignments?.forEach((assign, index) => {
                        const li = document.createElement('li');
                        li.className = 'dynamic-item';
                        const dataId = `assign-min-${index + 1}`;
                        const isChecked = followUpStatus[dataId] || false;
                        li.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" data-id="${dataId}" ${isChecked ? 'checked' : ''} aria-label="Check off assignment: ${assign.task}">
                                <span class="${isChecked ? 'checked-item' : ''}">Task: ${sanitizeInput(assign.task)} (Assigned to: ${sanitizeInput(assign.assignedTo || 'N/A')}, Status: ${assign.status})</span>
                            </label>
                        `;
                        previousItemsList.appendChild(li);
                        hasItems = true;
                    });
                    previousData.lessons?.forEach((lesson, index) => {
                        const li = document.createElement('li');
                        li.className = 'dynamic-item';
                        const dataId = `lesson-${index + 1}`;
                        const isChecked = followUpStatus[dataId] || false;
                        li.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" data-id="${dataId}" ${isChecked ? 'checked' : ''} aria-label="Check off lesson: ${lesson.name}">
                                <span class="${isChecked ? 'checked-item' : ''}">Lesson - Date: ${sanitizeInput(lesson.date || 'N/A')}, Teacher: ${sanitizeInput(lesson.name)}</span>
                            </label>
                        `;
                        previousItemsList.appendChild(li);
                        hasItems = true;
                    });
                    previousData.activities?.forEach((activity, index) => {
                        const li = document.createElement('li');
                        li.className = 'dynamic-item';
                        const dataId = `activity-${index + 1}`;
                        const isChecked = followUpStatus[dataId] || false;
                        li.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" data-id="${dataId}" ${isChecked ? 'checked' : ''} aria-label="Check off activity: ${activity.description}">
                                <span class="${isChecked ? 'checked-item' : ''}">Activity - Date: ${sanitizeInput(activity.date || 'N/A')}, Description: ${sanitizeInput(activity.description)}, Assigned to: ${sanitizeInput(activity.assignedTo || 'N/A')}</span>
                            </label>
                        `;
                        previousItemsList.appendChild(li);
                        hasItems = true;
                    });
                } catch (e) {
                    console.error('Error updating previous items:', e);
                }
            }
            document.getElementById('previous-assignments-display').style.display = hasItems || document.getElementById('previous-ideas-list').children.length > 0 ? 'block' : 'none';
        }

        // Update Review Items
        function updateReviewItems() {
            console.log('Updating review items');
            const reviewList = document.getElementById('review-items-list');
            reviewList.innerHTML = '';
            const formData = getFormData();
            const items = [
                ...formData.ministeringAssignments.map(a => `Ministering Assignment: ${a.task} (Assigned to: ${a.assignedTo || 'N/A'}, Status: ${a.status})`),
                ...formData.lessons.map(l => `Lesson - Date: ${l.date || 'N/A'}, Teacher: ${l.name}`),
                ...formData.activities.map(a => `Activity - Date: ${a.date || 'N/A'}, Description: ${a.description}, Assigned to: ${a.assignedTo || 'N/A'}`),
            ];
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dynamic-item';
                div.textContent = item;
                reviewList.appendChild(div);
            });
        }

        // Populate Form
        function populateForm(data) {
            console.log('Populating form with data:', data);
            clearDynamicLists();
            document.getElementById('meeting-date').value = data['meeting-date'] || '';
            document.getElementById('conducting').value = data['conducting'] || '';
            document.getElementById('opening-prayer').value = data['opening-prayer'] || '';
            document.getElementById('ministering-discussion').value = data['ministering-discussion'] || '';
            document.getElementById('sunday-discussion').value = data['sunday-discussion'] || '';
            document.getElementById('skills-ideas').value = data['skills-ideas'] || '';
            document.getElementById('temple-history').value = data['temple-history'] || '';
            document.getElementById('spirit-unity').value = data['spirit-unity'] || '';
            document.getElementById('leadership-instruction').value = data['leadership-instruction'] || '';
            document.getElementById('closing-prayer').value = data['closing-prayer'] || '';
            data.ministeringAssignments?.forEach(a => addMinisteringAssignment(a.task, a.assignedTo, a.status, a.confirmed));
            data.lessons?.forEach(l => addLesson(l.date, l.name, l.confirmed));
            data.activities?.forEach(a => addActivity(a.date, a.description, a.assignedTo, a.confirmed));
            updatePreviousIdeas();
            updatePreviousItems();
            updateReviewItems();
            resetValidation();
        }

        // Save Agenda
        function saveAgenda() {
            console.log('Saving agenda');
            const formData = getFormData();
            if (!formData['meeting-date'] || !formData['conducting'] || !formData['opening-prayer']) {
                showMessage('Please fill in all required fields', true);
                validateForm();
                return;
            }
            const key = `agenda_${formData['meeting-date']}`;
            localStorage.setItem(key, JSON.stringify(formData));
            localStorage.removeItem('agenda_draft');
            showMessage('Agenda saved');
        }

        // Autosave
        function triggerAutosave() {
            console.log('Triggering autosave');
            clearTimeout(autosaveTimeout);
            autosaveTimeout = setTimeout(() => {
                const formData = getFormData();
                localStorage.setItem('agenda_draft', JSON.stringify(formData));
                console.log('Autosaved draft');
            }, 1000);
        }

        // Validate Form
        function validateForm() {
            console.log('Validating form');
            const fields = ['meeting-date', 'conducting', 'opening-prayer'];
            let isValid = true;
            fields.forEach(id => {
                const input = document.getElementById(id);
                const error = document.getElementById(`${id}-error`);
                if (!input.value) {
                    input.classList.add('error-border');
                    error.classList.remove('hidden');
                    isValid = false;
                } else {
                    input.classList.remove('error-border');
                    error.classList.add('hidden');
                }
            });
            return isValid;
        }

        // Reset Validation
        function resetValidation() {
            console.log('Resetting validation');
            const fields = ['meeting-date', 'conducting', 'opening-prayer'];
            fields.forEach(id => {
                const input = document.getElementById(id);
                const error = document.getElementById(`${id}-error`);
                input.classList.remove('error-border');
                error.classList.add('hidden');
            });
        }

        // Create New Agenda
        function createNewAgenda() {
            console.log('Creating new agenda');
            clearForm();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('meeting-date').value = today;
            updatePreviousIdeas();
            updatePreviousItems();
            showMessage('New agenda created');
        }

        // Export as PDF
        function exportAsPDF() {
            console.log('Exporting as PDF');
            if (!jsPDF) {
                showMessage('PDF library not loaded', true);
                return;
            }
            const formData = getFormData();
            if (!formData['meeting-date']) {
                showMessage('Please enter a meeting date', true);
                return;
            }
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Presidency Meeting Agenda', 20, 20);
            doc.setFontSize(12);
            let y = 30;
            const addSection = (title, content, isList = false) => {
                if (content && (isList ? content.length : content)) {
                    doc.text(title, 20, y);
                    y += 10;
                    if (isList) {
                        content.forEach(item => {
                            doc.text(item, 25, y);
                            y += 7;
                        });
                    } else {
                        doc.text(content, 25, y);
                        y += 10;
                    }
                    y += 5;
                }
            };
            addSection('Meeting Details', [
                `Date: ${formData['meeting-date'] || 'N/A'}`,
                `Conducting: ${formData['conducting'] || 'N/A'}`,
                `Opening Prayer: ${formData['opening-prayer'] || 'N/A'}`,
            ], true);

            const previousKey = getPreviousAgendaKey(formData['meeting-date']);
            if (previousKey) {
                try {
                    const previousData = JSON.parse(localStorage.getItem(previousKey));
                    const followUpStatus = formData.followUpStatus || {};
                    const ideas = [
                        previousData['skills-ideas'] ? `Skills/Service: ${previousData['skills-ideas']}` : '',
                        previousData['sunday-discussion'] ? `Sunday Discussion: ${previousData['sunday-discussion']}` : '',
                        previousData['temple-history'] ? `Temple & Family History: ${previousData['temple-history']}` : '',
                        previousData['spirit-unity'] ? `Spirit/Unity: ${previousData['spirit-unity']}` : '',
                    ].filter(i => i).map((idea, index) => {
                        const dataId = `idea-${['skills', 'sunday', 'temple', 'spirit'][index]}-${index + 1}`;
                        return `${followUpStatus[dataId] ? '[x]' : '[ ]'} ${idea}`;
                    });
                    addSection('Ideas from Previous Meeting', ideas, true);
                    const previousItems = [
                        ...(previousData.ministeringAssignments?.map((a, i) => `${followUpStatus[`assign-min-${i + 1}`] ? '[x]' : '[ ]'} Task: ${a.task} (Assigned to: ${a.assignedTo || 'N/A'}, Status: ${a.status})`) || []),
                        ...(previousData.lessons?.map((l, i) => `${followUpStatus[`lesson-${i + 1}`] ? '[x]' : '[ ]'} Lesson - Date: ${l.date || 'N/A'}, Teacher: ${l.name}`) || []),
                        ...(previousData.activities?.map((a, i) => `${followUpStatus[`activity-${i + 1}`] ? '[x]' : '[ ]'} Activity - Date: ${a.date || 'N/A'}, Description: ${a.description}, Assigned to: ${a.assignedTo || 'N/A'}`) || []),
                    ];
                    addSection('Assignments from Previous Meeting', previousItems, true);
                } catch (e) {
                    console.error('Error exporting previous items to PDF:', e);
                }
            }
            addSection('Ministering', formData['ministering-discussion']);
            addSection('Ministering Assignments', formData.ministeringAssignments.map(a => `Task: ${a.task} (Assigned to: ${a.assignedTo || 'N/A'}, Status: ${a.status})`), true);
            addSection('Sunday Quorum/Class Meetings', formData['sunday-discussion']);
            addSection('Upcoming Lessons', formData.lessons.map(l => `Date: ${l.date || 'N/A'}, Teacher: ${l.name}`), true);
            addSection('Service & Activities', formData['skills-ideas']);
            addSection('Planned Service/Activities', formData.activities.map(a => `Date: ${a.date || 'N/A'}, Description: ${a.description}, Assigned to: ${a.assignedTo || 'N/A'}`), true);
            addSection('Temple & Family History / Sharing the Gospel', formData['temple-history']);
            addSection('Inviting the Spirit / Fostering Unity', formData['spirit-unity']);
            addSection('Leadership Instruction', formData['leadership-instruction']);
            addSection('Closing Prayer', formData['closing-prayer']);
            doc.save(`agenda_${formData['meeting-date'] || 'export'}.pdf`);
            showMessage('PDF exported');
        }

        // Event Listeners
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('view-past-button').addEventListener('click', openLoadModal);
        document.getElementById('close-modal-button').addEventListener('click', closeLoadModal);
        document.getElementById('load-button').addEventListener('click', () => {
            const key = loadAgendaSelect.value;
            if (key) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    populateForm(data);
                    closeLoadModal();
                    showMessage('Agenda loaded');
                } catch (e) {
                    showMessage('Error loading agenda', true);
                    console.error('Error loading agenda:', e);
                }
            } else {
                showMessage('Please select an agenda', true);
            }
        });
        document.getElementById('save-button').addEventListener('click', saveAgenda);
        document.getElementById('mobile-save-button').addEventListener('click', saveAgenda);
        document.getElementById('create-new-button').addEventListener('click', createNewAgenda);
        document.getElementById('mobile-create-new-button').addEventListener('click', createNewAgenda);
        document.getElementById('export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('mobile-export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('clear-button').addEventListener('click', clearForm);
        document.getElementById('mobile-clear-button').addEventListener('click', clearForm);
        document.getElementById('item-modal-confirm').addEventListener('click', () => {
            console.log('Confirming item modal:', { currentModalType, currentModalIndex });
            const modalForm = document.getElementById('item-modal-form');
            const requiredInputs = modalForm.querySelectorAll('input[required]');
            let isValid = true;
            requiredInputs.forEach(input => {
                if (!input.value) {
                    input.classList.add('error-border');
                    isValid = false;
                } else {
                    input.classList.remove('error-border');
                }
            });
            if (!isValid) {
                document.getElementById('item-modal-error').classList.remove('hidden');
                return;
            }
            let data = {};
            if (currentModalType === 'assignment') {
                data = {
                    task: document.getElementById('modal-task').value,
                    assignedTo: document.getElementById('modal-assigned').value,
                    status: document.getElementById('modal-status').value,
                };
                if (currentModalIndex === -1) {
                    addMinisteringAssignment(data.task, data.assignedTo, data.status, true);
                } else {
                    updateItem('assignment', currentModalIndex, data);
                }
            } else if (currentModalType === 'lesson') {
                data = {
                    date: document.getElementById('modal-date').value,
                    name: document.getElementById('modal-name').value,
                };
                if (currentModalIndex === -1) {
                    addLesson(data.date, data.name, true);
                } else {
                    updateItem('lesson', currentModalIndex, data);
                }
            } else if (currentModalType === 'activity') {
                data = {
                    date: document.getElementById('modal-date').value,
                    description: document.getElementById('modal-desc').value,
                    assignedTo: document.getElementById('modal-assigned').value,
                };
                if (currentModalIndex === -1) {
                    addActivity(data.date, data.description, data.assignedTo, true);
                } else {
                    updateItem('activity', currentModalIndex, data);
                }
            }
            closeItemModal();
        });
        document.getElementById('item-modal-cancel').addEventListener('click', closeItemModal);
        form.addEventListener('input', triggerAutosave);
        document.getElementById('accordion-toggle').addEventListener('change', (e) => {
            const details = document.querySelectorAll('details');
            if (e.target.checked) {
                details.forEach(d => d.removeAttribute('open'));
            } else {
                details.forEach(d => d.setAttribute('open', ''));
            }
        });

        // Checkbox Event Listener for Follow-Up Items
        document.addEventListener('change', (e) => {
            if (e.target.matches('#previous-ideas-list input[type="checkbox"], #previous-items-list input[type="checkbox"]')) {
                console.log('Checkbox changed:', e.target.dataset.id, e.target.checked);
                const dataId = e.target.dataset.id;
                const span = e.target.nextElementSibling;
                if (e.target.checked) {
                    span.classList.add('checked-item');
                } else {
                    span.classList.remove('checked-item');
                }
                triggerAutosave();
                showMessage(`Item ${e.target.checked ? 'checked' : 'unchecked'}`);
            }
        });

        // Initialize
        (function init() {
            console.log('Initializing app');
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            const draft = localStorage.getItem('agenda_draft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    populateForm(data);
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            } else {
                document.getElementById('meeting-date').value = new Date().toISOString().split('T')[0];
                updatePreviousIdeas();
                updatePreviousItems();
            }
            if (window.innerWidth <= 640) {
                document.getElementById('action-buttons').style.display = 'flex';
            }
        })();
    </script>
</body>
</html>
