<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidency Agenda Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #1f2937;
        }
        summary {
            cursor: pointer;
            padding: 1rem;
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }
        .dark summary {
            background-color: #6366f1;
        }
        summary:hover {
            background-color: #4338ca;
        }
        .dark summary:hover {
            background-color: #4f46e5;
        }
        summary::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.3s ease-in-out;
            margin-left: 0.5rem;
        }
        details[open] > summary::after {
            transform: rotate(180deg);
        }
        details > div {
            padding: 1.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .dark details > div {
            background-color: #374151;
            border-color: #4b5563;
        }
        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .dark input[type="text"],
        .dark input[type="date"],
        .dark textarea,
        .dark select {
            background-color: #4b5563;
            border-color: #6b7280;
            color: white;
        }
        textarea {
            min-height: 100px;
        }
        label {
            font-weight: 500;
            color: #374151;
        }
        .dark label {
            color: #d1d5db;
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            min-width: 48px;
            min-height: 48px;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .dynamic-item {
            border: 1px dashed #d1d5db;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            position: relative;
        }
        .dark .dynamic-item {
            background-color: #4b5563;
            border-color: #6b7280;
        }
        .remove-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
        }
        .pending-item {
            background-color: #fefcbf;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark .pending-item {
            background-color: #6b7280;
        }
        #message-box {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
        }
        #action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }
        .dark #action-buttons {
            background-color: #1f2937;
        }
        @media (max-width: 640px) {
            #action-buttons {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
            .max-w-2xl {
                max-width: 100%;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Presidency Meeting Agenda</h1>
            <button id="theme-toggle" class="btn-secondary" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="mb-6">
            <label for="load-agenda" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Load Previous Agenda:</label>
            <div class="flex">
                <select id="load-agenda" class="flex-grow">
                    <option value="">-- Select an Agenda --</option>
                </select>
                <button id="load-button" class="btn-secondary ml-2">Load</button>
            </div>
        </div>

        <div class="mb-6 flex items-center">
            <label for="accordion-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Accordion Mode (Mobile):</label>
            <input type="checkbox" id="accordion-toggle" checked class="h-5 w-5">
        </div>

        <form id="agenda-form">
            <details class="mb-4" open>
                <summary>Meeting Details</summary>
                <div class="space-y-4">
                    <div>
                        <label for="meeting-date">Date:</label>
                        <input type="date" id="meeting-date" name="meeting-date" required autocomplete="off">
                    </div>
                    <div>
                        <label for="conducting">Conducting:</label>
                        <input type="text" id="conducting" name="conducting" placeholder="Name of person conducting" autocomplete="name" required>
                    </div>
                    <div>
                        <label for="opening-prayer">Opening Prayer:</label>
                        <input type="text" id="opening-prayer" name="opening-prayer" placeholder="Name of person praying" autocomplete="name" required>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Follow-Up</summary>
                <div>
                    <label for="follow-up-notes">Assignments from previous meeting / ward youth council:</label>
                    <textarea id="follow-up-notes" name="follow-up-notes" placeholder="Discuss status of previous assignments..."></textarea>
                    <div id="previous-assignments-display" class="mt-4 text-sm text-gray-600 dark:text-gray-300">
                        <h4 class="font-semibold mb-2">Pending items from meetings:</h4>
                        <div id="pending-items-list"></div>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Ministering</summary>
                <div>
                    <label for="ministering-discussion">How can we invite and help our quorum or class come unto Christ? Support them and others?</label>
                    <textarea id="ministering-discussion" name="ministering-discussion" placeholder="Discussion notes..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Assignments:</h4>
                    <div id="ministering-assignments-list"></div>
                    <button type="button" onclick="addMinisteringAssignment()" class="btn-secondary text-sm"><i class="fas fa-plus mr-1"></i> Add Assignment</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Sunday Quorum/Class Meetings</summary>
                <div>
                    <label for="sunday-discussion">What to discuss with quorum/class members? (Ref: "Counsel Together")</label>
                    <textarea id="sunday-discussion" name="sunday-discussion" placeholder="Discussion points for Sunday..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Upcoming Lessons:</h4>
                    <div id="lessons-list"></div>
                    <button type="button" onclick="addLesson()" class="btn-secondary text-sm"><i class="fas fa-plus mr-1"></i> Add Lesson</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Service & Activities</summary>
                <div>
                    <label for="skills-ideas">Skills to learn/develop? How to serve others?</label>
                    <textarea id="skills-ideas" name="skills-ideas" placeholder="Brainstorm ideas..."></textarea>
                    <h4 class="font-semibold mt-4 mb-2">Planned Service/Activities:</h4>
                    <div id="activities-list"></div>
                    <button type="button" onclick="addActivity()" class="btn-secondary text-sm"><i class="fas fa-plus mr-1"></i> Add Activity</button>
                </div>
            </details>

            <details class="mb-4">
                <summary>Other Discussion Items</summary>
                <div class="space-y-4">
                    <div>
                        <label for="temple-history">Temple & Family History / Sharing the Gospel:</label>
                        <textarea id="temple-history" name="temple-history" placeholder="Notes on participation..."></textarea>
                    </div>
                    <div>
                        <label for="spirit-unity">Inviting the Spirit / Fostering Unity:</label>
                        <textarea id="spirit-unity" name="spirit-unity" placeholder="Ideas and plans..."></textarea>
                    </div>
                </div>
            </details>

            <details class="mb-4">
                <summary>Leadership Instruction</summary>
                <div>
                    <label for="leadership-instruction">Notes from Bishopric Member or Adult Adviser:</label>
                    <textarea id="leadership-instruction" name="leadership-instruction" placeholder="Record instructions given..."></textarea>
                </div>
            </details>

            <details class="mb-4">
                <summary>Review & Closing</summary>
                <div class="space-y-4">
                    <div>
                        <label for="review-assignments">Review Assignments Made This Meeting:</label>
                        <textarea id="review-assignments" name="review-assignments" placeholder="Final check on who is doing what..."></textarea>
                    </div>
                    <div>
                        <label for="closing-prayer">Closing Prayer:</label>
                        <input type="text" id="closing-prayer" name="closing-prayer" placeholder="Name of person praying" autocomplete="name">
                    </div>
                </div>
            </details>

            <div class="mt-8 flex flex-wrap justify-center gap-4" id="desktop-buttons">
                <button type="button" id="save-button" class="btn-primary"><i class="fas fa-save mr-1"></i> Save Agenda</button>
                <button type="button" id="generate-next-button" class="btn-primary"><i class="fas fa-arrow-right mr-1"></i> Next Agenda</button>
                <button type="button" id="export-pdf-button" class="btn-primary"><i class="fas fa-file-pdf mr-1"></i> Export as PDF</button>
                <button type="button" id="export-json-button" class="btn-primary"><i class="fas fa-download mr-1"></i> Export as JSON</button>
                <label class="btn-primary flex items-center cursor-pointer">
                    <i class="fas fa-upload mr-1"></i> Import JSON
                    <input type="file" id="import-json-button" accept=".json" class="hidden">
                </label>
                <button type="button" id="clear-button" class="btn-secondary"><i class="fas fa-eraser mr-1"></i> Clear Form</button>
            </div>
        </form>

        <div id="action-buttons" class="hidden sm:hidden">
            <button type="button" id="mobile-save-button" class="btn-primary"><i class="fas fa-save"></i></button>
            <button type="button" id="mobile-generate-next-button" class="btn-primary"><i class="fas fa-arrow-right"></i></button>
            <button type="button" id="mobile-export-pdf-button" class="btn-primary"><i class="fas fa-file-pdf"></i></button>
            <button type="button" id="mobile-clear-button" class="btn-secondary"><i class="fas fa-eraser"></i></button>
        </div>
    </div>

    <div id="message-box"></div>

    <script>
        const { jsPDF } = window.jspdf || {};
        const form = document.getElementById('agenda-form');
        const loadAgendaSelect = document.getElementById('load-agenda');
        const messageBox = document.getElementById('message-box');
        let messageTimeout;
        let ministeringAssignmentCount = 0;
        let lessonCount = 0;
        let activityCount = 0;
        let autosaveTimeout;

        // Theme Handling
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // Show Message
        function showMessage(message, duration = 3000) {
            console.log('Showing message:', message);
            messageBox.textContent = message;
            messageBox.classList.add('show');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Get Saved Agenda Keys
        function getSavedAgendaKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('agenda_') && key !== 'agenda_draft') {
                    keys.push(key);
                }
            }
            return keys.sort();
        }

        // Populate Load Agenda Dropdown
        function populateLoadAgendaDropdown() {
            const keys = getSavedAgendaKeys();
            loadAgendaSelect.innerHTML = '<option value="">-- Select an Agenda --</option>';
            keys.forEach(key => {
                let displayName = key.replace('agenda_', '');
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data['meeting-date']) {
                        displayName = `Agenda ${data['meeting-date']}`;
                    }
                } catch (e) {
                    console.error('Error parsing stored agenda data:', e);
                }
                const option = document.createElement('option');
                option.value = key;
                option.textContent = displayName;
                loadAgendaSelect.appendChild(option);
            });
        }

        // Clear Dynamic Lists
        function clearDynamicLists() {
            document.getElementById('ministering-assignments-list').innerHTML = '';
            document.getElementById('lessons-list').innerHTML = '';
            document.getElementById('activities-list').innerHTML = '';
            document.getElementById('pending-items-list').innerHTML = '';
            ministeringAssignmentCount = 0;
            lessonCount = 0;
            activityCount = 0;
        }

        // Clear Form
        function clearForm() {
            form.reset();
            clearDynamicLists();
            document.getElementById('previous-assignments-display').style.display = 'none';
            localStorage.removeItem('agenda_draft');
            showMessage('Form cleared', 1500);
        }

        // Sanitize Input
        function sanitizeInput(value) {
            const div = document.createElement('div');
            div.textContent = value;
            return div.innerHTML;
        }

        // Add Ministering Assignment
        function addMinisteringAssignment(task = '', assignedTo = '', status = 'Pending') {
            console.log('Adding ministering assignment:', { task, assignedTo, status });
            ministeringAssignmentCount++;
            const list = document.getElementById('ministering-assignments-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item ministering-assignment-item';
            div.id = `min-assign-${ministeringAssignmentCount}`;
            div.innerHTML = `
                <button type="button" class="btn-danger remove-btn" onclick="removeItem('min-assign-${ministeringAssignmentCount}')"><i class="fas fa-times"></i></button>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="min-task-${ministeringAssignmentCount}" class="text-sm font-medium">Task:</label>
                        <input type="text" id="min-task-${ministeringAssignmentCount}" name="min-task-${ministeringAssignmentCount}" value="${sanitizeInput(task)}" placeholder="Assignment description">
                    </div>
                    <div>
                        <label for="min-assigned-${ministeringAssignmentCount}" class="text-sm font-medium">Assigned To:</label>
                        <input type="text" id="min-assigned-${ministeringAssignmentCount}" name="min-assigned-${ministeringAssignmentCount}" value="${sanitizeInput(assignedTo)}" placeholder="Name">
                    </div>
                    <div>
                        <label for="min-status-${ministeringAssignmentCount}" class="text-sm font-medium">Status:</label>
                        <select id="min-status-${ministeringAssignmentCount}" name="min-status-${ministeringAssignmentCount}">
                            <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Done" ${status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                    </div>
                </div>
            `;
            list.appendChild(div);
            // Attach event listeners to new inputs
            div.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', triggerAutosave);
                input.addEventListener('change', triggerAutosave);
            });
            triggerAutosave();
            showMessage('Assignment added', 1500);
        }

        // Add Lesson
        function addLesson(date = '', name = '') {
            lessonCount++;
            const list = document.getElementById('lessons-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item lesson-item';
            div.id = `lesson-${lessonCount}`;
            div.innerHTML = `
                <button type="button" class="btn-danger remove-btn" onclick="removeItem('lesson-${lessonCount}')"><i class="fas fa-times"></i></button>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="lesson-date-${lessonCount}" class="text-sm font-medium">Date:</label>
                        <input type="date" id="lesson-date-${lessonCount}" name="lesson-date-${lessonCount}" value="${sanitizeInput(date)}">
                    </div>
                    <div>
                        <label for="lesson-name-${lessonCount}" class="text-sm font-medium">Teacher Name:</label>
                        <input type="text" id="lesson-name-${lessonCount}" name="lesson-name-${lessonCount}" value="${sanitizeInput(name)}" placeholder="Name">
                    </div>
                </div>
            `;
            list.appendChild(div);
            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', triggerAutosave);
                input.addEventListener('change', triggerAutosave);
            });
            triggerAutosave();
        }

        // Add Activity
        function addActivity(date = '', activityDesc = '', assignedTo = '') {
            activityCount++;
            const list = document.getElementById('activities-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item activity-item';
            div.id = `activity-${activityCount}`;
            div.innerHTML = `
                <button type="button" class="btn-danger remove-btn" onclick="removeItem('activity-${activityCount}')"><i class="fas fa-times"></i></button>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="activity-date-${activityCount}" class="text-sm font-medium">Date:</label>
                        <input type="date" id="activity-date-${activityCount}" name="activity-date-${activityCount}" value="${sanitizeInput(date)}">
                    </div>
                    <div>
                        <label for="activity-desc-${activityCount}" class="text-sm font-medium">Activity:</label>
                        <input type="text" id="activity-desc-${activityCount}" name="activity-desc-${activityCount}" value="${sanitizeInput(activityDesc)}" placeholder="Activity description">
                    </div>
                    <div>
                        <label for="activity-assigned-${activityCount}" class="text-sm font-medium">Assigned To:</label>
                        <input type="text" id="activity-assigned-${activityCount}" name="activity-assigned-${activityCount}" value="${sanitizeInput(assignedTo)}" placeholder="Name(s)">
                    </div>
                </div>
            `;
            list.appendChild(div);
            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', triggerAutosave);
                input.addEventListener('change', triggerAutosave);
            });
            triggerAutosave();
        }

        // Remove Dynamic Item
        function removeItem(id) {
            const item = document.getElementById(id);
            if (item) {
                item.remove();
                triggerAutosave();
                showMessage('Item removed', 1500);
            }
        }

        // Get Form Data
        function getFormData() {
            console.log('Collecting form data');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (!key.startsWith('min-') && !key.startsWith('lesson-') && !key.startsWith('activity-')) {
                    data[key] = value;
                }
            }
            data.ministeringAssignments = [];
            document.querySelectorAll('.ministering-assignment-item').forEach(item => {
                const idNum = item.id.split('-')[2];
                const taskInput = item.querySelector(`#min-task-${idNum}`);
                const assignedInput = item.querySelector(`#min-assigned-${idNum}`);
                const statusInput = item.querySelector(`#min-status-${idNum}`);
                if (taskInput && assignedInput && statusInput) {
                    data.ministeringAssignments.push({
                        task: taskInput.value,
                        assignedTo: assignedInput.value,
                        status: statusInput.value,
                    });
                }
            });
            data.lessons = [];
            document.querySelectorAll('.lesson-item').forEach(item => {
                const idNum = item.id.split('-')[1];
                const dateInput = item.querySelector(`#lesson-date-${idNum}`);
                const nameInput = item.querySelector(`#lesson-name-${idNum}`);
                if (dateInput && nameInput) {
                    data.lessons.push({
                        date: dateInput.value,
                        name: nameInput.value,
                    });
                }
            });
            data.activities = [];
            document.querySelectorAll('.activity-item').forEach(item => {
                const idNum = item.id.split('-')[1];
                const dateInput = item.querySelector(`#activity-date-${idNum}`);
                const descInput = item.querySelector(`#activity-desc-${idNum}`);
                const assignedInput = item.querySelector(`#activity-assigned-${idNum}`);
                if (dateInput && descInput && assignedInput) {
                    data.activities.push({
                        date: dateInput.value,
                        description: descInput.value,
                        assignedTo: assignedInput.value,
                    });
                }
            });
            console.log('Form data collected:', data);
            return data;
        }

        // Populate Form
        function populateForm(data, showPending = true) {
            console.log('Populating form with data:', data);
            clearForm();
            for (const key in data) {
                if (form.elements[key]) {
                    form.elements[key].value = data[key];
                }
            }
            if (data.ministeringAssignments) {
                data.ministeringAssignments.forEach(item => {
                    addMinisteringAssignment(item.task, item.assignedTo, item.status);
                });
            }
            if (data.lessons) {
                data.lessons.forEach(item => {
                    addLesson(item.date, item.name);
                });
            }
            if (data.activities) {
                data.activities.forEach(item => {
                    addActivity(item.date, item.description, item.assignedTo);
                });
            }
            if (showPending) {
                updatePendingItems(data);
            } else {
                document.getElementById('previous-assignments-display').style.display = 'none';
            }
        }

        // Update Pending Items
        function updatePendingItems(data) {
            console.log('Updating pending items:', data);
            const pendingItemsList = document.getElementById('pending-items-list');
            const pendingItemsDisplay = document.getElementById('previous-assignments-display');
            pendingItemsList.innerHTML = '';
            let hasPendingItems = false;
            if (data && data.ministeringAssignments) {
                data.ministeringAssignments.forEach((item, index) => {
                    if (item.status === 'Pending') {
                        const div = document.createElement('div');
                        div.className = 'pending-item';
                        div.innerHTML = `
                            <span><i class="fas fa-tasks mr-2"></i>${sanitizeInput(item.task)} (Assigned to: ${sanitizeInput(item.assignedTo || 'N/A')})</span>
                            <button type="button" class="btn-success" onclick="markPendingDone('${sanitizeInput(data['meeting-date'])}', ${index})"><i class="fas fa-check mr-1"></i>Mark as Done</button>
                        `;
                        pendingItemsList.appendChild(div);
                        hasPendingItems = true;
                    }
                });
            }
            pendingItemsDisplay.style.display = hasPendingItems ? 'block' : 'none';
        }

        // Mark Pending Item as Done
        function markPendingDone(meetingDate, index) {
            console.log('Marking pending item as done:', { meetingDate, index });
            const key = `agenda_${meetingDate}`;
            try {
                const data = JSON.parse(localStorage.getItem(key));
                if (data && data.ministeringAssignments[index]) {
                    data.ministeringAssignments[index].status = 'Done';
                    localStorage.setItem(key, JSON.stringify(data));
                    updatePendingItems(data);
                    showMessage('Assignment marked as done.', 2000);
                } else {
                    showMessage('Assignment not found.', 3000);
                }
            } catch (e) {
                console.error('Error updating pending item:', e);
                showMessage('Error updating assignment.', 3000);
            }
        }

        // Validate Form
        function validateForm(data) {
            console.log('Validating form data:', data);
            const errors = [];
            if (!data['meeting-date']) errors.push('Meeting Date is required.');
            if (!data['conducting']) errors.push('Conducting person is required.');
            if (!data['opening-prayer']) errors.push('Opening Prayer person is required.');
            return errors;
        }

        // Save Agenda
        function saveAgenda() {
            console.log('Saving agenda');
            const data = getFormData();
            const errors = validateForm(data);
            if (errors.length > 0) {
                showMessage(errors.join(' '), 4000);
                return;
            }
            const key = `agenda_${data['meeting-date']}`;
            try {
                localStorage.setItem(key, JSON.stringify(data));
                localStorage.removeItem('agenda_draft');
                showMessage(`Agenda for ${data['meeting-date']} saved successfully!`);
                populateLoadAgendaDropdown();
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showMessage('Error saving agenda. Storage might be full.', 4000);
            }
        }

        // Autosave
        function triggerAutosave() {
            console.log('Triggering autosave');
            clearTimeout(autosaveTimeout);
            autosaveTimeout = setTimeout(() => {
                const data = getFormData();
                if (data['meeting-date']) {
                    try {
                        localStorage.setItem('agenda_draft', JSON.stringify(data));
                        showMessage('Draft saved', 1500);
                    } catch (e) {
                        console.error('Error autosaving draft:', e);
                        showMessage('Error saving draft.', 3000);
                    }
                }
            }, 1000);
        }

        // Load Agenda
        function loadAgenda() {
            console.log('Loading agenda');
            const selectedKey = loadAgendaSelect.value;
            if (!selectedKey) {
                showMessage('Please select an agenda to load.', 2000);
                return;
            }
            try {
                const dataString = localStorage.getItem(selectedKey);
                if (dataString) {
                    const data = JSON.parse(dataString);
                    populateForm(data, false);
                    showMessage(`Loaded agenda: ${selectedKey.replace('agenda_', '')}`);
                } else {
                    showMessage('Could not find saved data for this agenda.', 3000);
                }
            } catch (e) {
                console.error('Error loading agenda:', e);
                showMessage('Error loading agenda.', 3000);
            }
        }

        // Generate Next Agenda
        function generateNextAgenda() {
            console.log('Generating next agenda');
            const currentData = getFormData();
            const errors = validateForm(currentData);
            if (errors.length > 0) {
                showMessage('Please complete required fields before starting next agenda.', 4000);
                return;
            }
            clearForm();
            const lastDateStr = currentData['meeting-date'];
            if (lastDateStr) {
                try {
                    const lastDate = new Date(lastDateStr + 'T00:00:00');
                    if (!isNaN(lastDate.getTime())) {
                        lastDate.setDate(lastDate.getDate() + 7);
                        const year = lastDate.getFullYear();
                        const month = String(lastDate.getMonth() + 1).padStart(2, '0');
                        const day = String(lastDate.getDate()).padStart(2, '0');
                        form.elements['meeting-date'].value = `${year}-${month}-${day}`;
                    }
                } catch (e) {
                    console.error('Error calculating next date:', e);
                }
            }
            updatePendingItems(currentData);
            showMessage('Form prepared for next agenda. Pending items added to Follow-Up.', 4000);
            document.querySelector('details:nth-of-type(2)').open = true;
        }

        // Export as PDF
        function exportAsPDF() {
            console.log('Exporting as PDF');
            if (!jsPDF) {
                showMessage('PDF library not loaded. Please try again.', 4000);
                return;
            }
            const data = getFormData();
            const errors = validateForm(data);
            if (errors.length > 0) {
                showMessage('Please complete required fields before exporting.', 4000);
                return;
            }
            try {
                const doc = new jsPDF();
                let y = 10;
                const pageHeight = doc.internal.pageSize.height;
                const maxWidth = 180;

                // Helper function to add text and handle pagination
                function addText(text, x, y, options = {}) {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = 10;
                    }
                    doc.text(text, x, y, options);
                    return y + (options.maxWidth ? doc.getTextDimensions(text, options).h : 7);
                }

                doc.setFontSize(16);
                y = addText('Presidency Meeting Agenda', 10, y);
                doc.setFontSize(12);
                y = addText(`Date: ${data['meeting-date'] || 'N/A'}`, 10, y);
                y = addText(`Conducting: ${data['conducting'] || 'N/A'}`, 10, y);
                y = addText(`Opening Prayer: ${data['opening-prayer'] || 'N/A'}`, 10, y);
                y += 5;

                doc.setFontSize(14);
                y = addText('Ministering', 10, y);
                doc.setFontSize(12);
                y = addText(data['ministering-discussion'] || 'No notes', 10, y, { maxWidth });
                if (data.ministeringAssignments && data.ministeringAssignments.length > 0) {
                    data.ministeringAssignments.forEach(item => {
                        const text = `- ${item.task || 'No task'} (Assigned to: ${item.assignedTo || 'N/A'}, Status: ${item.status || 'N/A'})`;
                        y = addText(text, 15, y);
                    });
                } else {
                    y = addText('No assignments', 15, y);
                }

                doc.setFontSize(14);
                y = addText('Review & Closing', 10, y);
                doc.setFontSize(12);
                y = addText(`Closing Prayer: ${data['closing-prayer'] || 'N/A'}`, 10, y);

                doc.save(`Agenda_${data['meeting-date'] || 'untitled'}.pdf`);
                showMessage('Agenda exported as PDF.', 2000);
            } catch (e) {
                console.error('Error exporting PDF:', e);
                showMessage('Error exporting PDF.', 4000);
            }
        }

        // Export as JSON
        function exportAsJSON() {
            console.log('Exporting as JSON');
            const data = getFormData();
            const errors = validateForm(data);
            if (errors.length > 0) {
                showMessage('Please complete required fields before exporting.', 4000);
                return;
            }
            try {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Agenda_${data['meeting-date'] || 'untitled'}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage('Agenda exported as JSON.', 2000);
            } catch (e) {
                console.error('Error exporting JSON:', e);
                showMessage('Error exporting JSON.', 4000);
            }
        }

        // Import JSON
        function importJSON(event) {
            console.log('Importing JSON');
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    populateForm(data);
                    showMessage('Agenda imported successfully.', 2000);
                } catch (e) {
                    console.error('Error parsing JSON file:', e);
                    showMessage('Error importing agenda. Invalid JSON file.', 3000);
                }
            };
            reader.readAsText(file);
        }

        // Accordion Behavior
        function setupAccordion() {
            const accordionToggle = document.getElementById('accordion-toggle');
            const detailsElements = document.querySelectorAll('details');
            detailsElements.forEach(detail => {
                detail.addEventListener('toggle', () => {
                    if (accordionToggle.checked && window.innerWidth < 640 && detail.open) {
                        detailsElements.forEach(other => {
                            if (other !== detail) other.open = false;
                        });
                    }
                });
            });
        }

        // Event Listeners
        document.getElementById('save-button').addEventListener('click', saveAgenda);
        document.getElementById('mobile-save-button').addEventListener('click', saveAgenda);
        document.getElementById('load-button').addEventListener('click', loadAgenda);
        document.getElementById('generate-next-button').addEventListener('click', generateNextAgenda);
        document.getElementById('mobile-generate-next-button').addEventListener('click', generateNextAgenda);
        document.getElementById('export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('mobile-export-pdf-button').addEventListener('click', exportAsPDF);
        document.getElementById('export-json-button').addEventListener('click', exportAsJSON);
        document.getElementById('import-json-button').addEventListener('change', importJSON);
        document.getElementById('clear-button').addEventListener('click', clearForm);
        document.getElementById('mobile-clear-button').addEventListener('click', clearForm);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        form.addEventListener('input', triggerAutosave);
        form.addEventListener('change', triggerAutosave);

        // Initial Setup
        window.addEventListener('load', () => {
            console.log('Initializing app');
            populateLoadAgendaDropdown();
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            if (!form.elements['meeting-date'].value) {
                form.elements['meeting-date'].value = `${year}-${month}-${day}`;
            }
            document.getElementById('previous-assignments-display').style.display = 'none';
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            const draft = localStorage.getItem('agenda_draft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    populateForm(data);
                    showMessage('Loaded draft from last session.', 2000);
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
            setupAccordion();
        });
    </script>
</body>
</html>
